<!DOCTYPE html>
<html lang="en">

<head>
    <title>FACTURACIÓN</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../css/index.css">

    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/bootstrap.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/firebase.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jspdf.customfonts.min.js "></script>
    <script language="javascript" type="text/javascript" src="../js/default_vfs.js"></script>
    <script language="javascript" type="text/javascript" src="../js/defiant.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/qrcode.js"></script>
    <script language="javascript" type="text/javascript" src="../js/index.js"></script>
    <script language="javascript" type="text/javascript" src="../js/aes.js"></script> 
    <script language="javascript" type="text/javascript" src="../js/invoice.js"></script>
    <script language="javascript" type="text/javascript" src="../js/facturama.api.js"></script>

    <script>
        var products,
            defiantClients;

        var orderRefID = "",
            clientName = "",
            clientRFC = "",
            clientCfdiUse = "",
            clientCfdiRegime = "",
            clientEmail = "",
            clientTaxZipCode = "";

        var invoiceID = "";
        
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database().ref('products/');
        database.on('value', function (snapshot) {
            products = Defiant.getSnapshot(snapshot.val());
        });

        var globalComputer = "liveView0";
        var aesEcb = new aesjs.ModeOfOperation.ecb(aesMethod);

        var taxedProducts,
            ieps2Products;

        var iepsProducts = [],
            ivaProducts = [];

        firebase.database().ref('taxes/ieps').once('value', function (snapshot) {
            taxedProducts = snapshot.val();
        }).then(function () {
            $.each(taxedProducts, function (key, value) {
                iepsProducts.push(key);
            });
        });

        firebase.database().ref('taxes/iva').once('value', function (snapshot) {
            taxedProducts = snapshot.val();
        }).then(function () {
            $.each(taxedProducts, function (key, value) {
                ivaProducts.push(key);
            });
        });
        
        firebase.database().ref('taxes/ieps2').once('value', function (snapshot) {
            ieps2Products = snapshot.val();
        });

        Facturama.Clients.List(function(result) {
            defiantClients = Defiant.getSnapshot(result);
        });

        var jsonClientsResponse = JSON.parse(httpGet("https://api.facturama.mx/clients?start=0&length=100"));
        var totalClients = jsonClientsResponse.recordsTotal;
        var jsonClientsClean = jsonClientsResponse.data;

        for(var i = 100; i < totalClients; i += 100)
            jsonClientsClean = jsonClientsClean.concat(JSON.parse(httpGet("https://api.facturama.mx/clients?start=" + i + "&length=100")).data);

        defiantClients = Defiant.getSnapshot(jsonClientsClean);
        console.log(defiantClients);
        
        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", theUrl, false );
            xmlHttp.setRequestHeader("Authorization", "Basic Y3JlbWVyaWFpbXBlcmlvOnhhenRZdC1qdXpjaWMtMnhldGp5");
            xmlHttp.send( null );
            return xmlHttp.responseText;
        }

    </script>

</head>

<body>
    <div id="splashScreen">
		<img id="logoImage2" type="image" onclick="userFullscreen();" src="../css/imperial2.png"></img>
        <input id="inputFirst" class="form-control" type="password" min="0"></input>
	</div>

    <div class="alert alert-danger" style="display: none" id="noConnectionAlert" role="alert">
        <strong> No hay internet. </strong>
        Revisa la conexión o el modem. Puedes seguir trabajando pero las cremas, jamones y otros productos no serán
        enviados a sus departamentos.
    </div>

    <div id="qrcode" style="position: absolute; left: -9999px"></div>

    <div class="container-fluid">
        <div class="form-group row first-row" style="padding: 5px 15px">
            <div id="inputNameContainer" class="col-md-7" style="padding-left: 0">
                <input style="float: left; width: 91.5%; margin-top: 1px; padding-right: 36px;" type="input" oninput="this.value = this.value.toUpperCase()" class="form-control" id="inputName" 
                    placeholder="NOMBRE"> 
                </input>
                <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-plus-sign"
                    id="addClientButton" style="float:right; font-weight: bold; height: 34px;"
                    onclick="showAddClientModal()">
                </button>
                <ul class="list-group client-options" id="clientOptions"></ul>
                <span id="greenCheck" class="glyphicon glyphicon-ok"></span>
            </div>
            <div class="col-md-3 row" style="padding-right: 20px;">
                <div class="col-sm-6 form-group" style="top:1.5px; padding-left: 30px; padding-right: 5px;">
                    <select class="form-control" id="paymentMethodSelect">
                        <option value="PUE" selected>UN PAGO</option>
                        <option value="PPD">EN PAGOS</option>
                    </select>
                </div>
                <div class="col-sm-6 form-group" style="top:1.5px; padding-left: 5px; padding-right: 30px;">
                    <select class="form-control" id="paymentFormSelect">
                        <option value="01" selected>EFECTIVO</option>
                        <option value="02">CHEQUE</option>
                        <option value="03">TRANSFE.</option>
                        <option value="04">T.CREDITO</option>
                        <option value="28">T.DEBITO</option>
                        <option value="99">P/DEFINIR</option>
                    </select>
                </div>
            </div>
            
            <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-send" id="sendInvoiceButton"
                style="float: right; font-weight: bold;" onclick="generateInvoice()"></button>
            <button type="button" class="btn btn-danger interface-button glyphicon glyphicon-print"
                id="printInvoiceButton" style="float: right; margin-right: 5px; font-weight: bold;"
                onclick="generateInvoice()"></button>
            <button type="button" class="btn btn-secondary interface-button glyphicon glyphicon-circle-arrow-down"
                id="showInvoiceIdModalButton" style="float: right; margin-right: 5px; font-weight: bold;"
                onclick="showInvoiceIdModal()"></button>
            <button type="button" class="btn btn-secondary interface-button glyphicon glyphicon-plus-sign"
                style="float: right; margin-right: 5px; font-weight: bold;"
                onclick="addProductModal();"></button>            
            <span id="totalTextFieldA" style="color: white; z-index: 100; position: fixed; padding-top: 10px; top: 76px;"></span>
        </div>

        <div class="row" style="margin-bottom: 15px">
            <div class="col-md-1" style="padding-right: 0px">
                <input type="number" min="0" id="quantityInput" class="form-control"></input>
            </div>
            <div class="col-md-11">
                <input type="d" class="form-control" id="inputSearch" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE O DESCRIPCION"></input>
            </div>
        </div>

        <ul class="list-group search-options" id="searchOptions"></ul>
        <ul class="list-group" id="dynamic-list"> </ul>
    </div>

    <div id="calculatorContainer">
        <div id="calculator">
            <div class="result"> <p></p> </div>
            <div class="clear btn-danger">C</div>
         
            <span class="calculator-button" style="margin-top: 22.5px; margin-left: 0;">7</span>
            <span class="calculator-button" style="margin-top: 22.5px;">8</span>
            <span class="calculator-button" style="margin-top: 22.5px;">9</span>
            <span class="calculator-button" style="margin-top: 22.5px; margin-right: 0px;">+</span>
         
            <span class="calculator-button" style="margin-left: 0px;">4</span>
            <span class="calculator-button">5</span>
            <span class="calculator-button">6</span>
            <span class="calculator-button" style="margin-right: 0px;">-</span>
         
            <span class="calculator-button" style="margin-left: 0px;">1</span>
            <span class="calculator-button">2</span>
            <span class="calculator-button">3</span>
            <span class="calculator-button" style="margin-right: 0px;">÷</span>
         
            <span class="calculator-button" style="margin-left: 0px;">0</span>
            <span class="calculator-button">.</span>
            <span class="calculator-button">=</span>
            <span class="calculator-button" style="margin-right: 0px;">x</span>
          </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title" id="addProductModalLabel">AGREGAR PRODUCTO</h4>
                </div>
                <div class="modal-body">
                    <form id="addNewProductDBForm">
                        
                        <div class="form-group">
                            <label id="verificationMessage" style="color: red;"></label>
                            <div class="row" style="margin-bottom: 15px;">
                                <div class="col-sm-8">
                                    <label for="descriptionInput">DESCRIPCION</label>
                                    <input oninput="this.value = this.value.toUpperCase()" class="form-control" id="descriptionInputModal"
                                        type="text" maxlength="38" placeholder="DESCRIPCION" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="IDInput">CLAVE</label>
                                    <input id="inputID" oninput="this.value = this.value.toUpperCase()"
                                        class="form-control" type="text" placeholder="CLAVE" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="SATLabel">SAT</label>
                                    <input id="SATInput" oninput="this.value = this.value.toUpperCase()"
                                        class="form-control" type="text" placeholder="CODIGO" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="priceInput">COSTO</label>
                                    <input id="priceInputModal" class="form-control" type="number" min="0" placeholder="8.50" required>
                                </div>
                                <div class="col-sm-2">
                                   <div class="form-group">
                                       <label for="unitSelect">UNIDAD</label>
                                       <select class="form-control" id="unitSelect">
                                           <option value="PIEZA" selected>PIEZA</option>
                                           <option value="KILO">KILO</option>
                                           <option value="CAJA">CAJA</option>
                                           <option value="PROMO">PROMO</option>
                                           <option value="CUB">CUB</option>
                                       </select>
                                   </div>
                               </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="stockSelect">EXISTENCIA</label>
                                        <select class="form-control" id="stockSelect">
                                            <option value="siHay">SÍ HAY</option>
                                            <option value="noHay">NO HAY</option>
                                            <option value="pedido">NO HAY / YA SE PIDIÓ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="typeSelect">TIPO</label>
                                        <select class="form-control" id="typeSelect">
                                            <option value="porPesarCamara">CAMARA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoCamara">CAMARA - YA VIENE PESADO</option>
                                            <option value="porPesarAfuera">AFUERA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoAfuera">AFUERA - YA VIENE PESADO</option>
                                            <option value="yaPesadoAfueraTrino">AFUERA - YA VIENE PESADO - TRINO
                                            </option>
                                            <option value="aJamones">AREA DE JAMONES</option>
                                            <option value="aCremas">AREA DE CREMAS</option>
                                            <option value="aBodega">AREA DE BODEGA</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">CANCELAR</button>
                    <button type="button" id="deleteButton" class="btn btn-danger" data-dismiss="modal"
                        onclick="deleteProductDB();" style="display: none">ELIMINAR</button>
                    <button type="button" class="btn btn-danger" id="saveButton" data-type="newProduct"
                        onclick="verificateNewProduct();">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceIdModal" tabindex="-1" role="dialog" aria-labelledby="invoiceIdModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title" id="invoiceIdModalLabel">BUSCAR NOTA</h4>
                </div>
                <div class="modal-body">
                    <form id="searchOrderForm">
                        <div class="form-group">
                            <label id="verificationMessageId" style="color: red;"></label>
                            <div class="row" style="margin-bottom: 15px;">
                                <div class="col-sm-4">
                                    <label for="idInput">CODIGO DE NOTA</label>
                                    <input id="invoiceCode" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" maxlength="38" placeholder="ESCANEA EL CODIGO">
                                </div>
                                <div class="col-sm-1" style="padding-top: 40px; text-align: center;">
                                    <label>-Ó-</label>
                                </div>
                                <div class="col-sm-5">
                                    <label for="nameInput">NOMBRE</label>
                                    <input oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="NOMBRE EN NOTA">
                                </div>
                                <div class="col-sm-2">
                                    <label for="totalInput">SUBTOTAL</label>
                                    <input id="invoiceTotal" class="form-control" type="number" min="0" placeholder="TOTAL">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">CANCELAR</button>
                    <button type="button" class="btn btn-danger" id="searchIdButton"
                        onclick="verificateOrderSearch();">BUSCAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addClientModal" tabindex="-1" role="dialog" aria-labelledby="addClientModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addClientModalLabel">NUEVO CLIENTE</h4>
                </div>
                <div class="modal-body">
                    <form id="addClientForm" onsubmit="return verificateNewClient(event)">
                        <div class="form-group">
                            <label id="addClientMessage" style="color: red;"></label>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col-sm-8">
                                    <label for="nameInput">NOMBRE / RAZÓN SOCIAL</label>
                                    <input id="nameNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-4">
                                    <label for="rfcInput">RFC</label>
                                    <input id="rfcNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" minlength="12" maxlength="13" placeholder="" required>
                                </div>
                            </div>
                            <div class="row" style="margin-bottom: 20px;">
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="cfdiRegimeSelect">RÉGIMEN</label>
                                        <select class="form-control" id="cfdiRegimeNC" required>
                                            <option value="601">601 - GENERAL DE LEY PERSONAS MORALES</option>
                                            <option value="603">603 - PERSONAS MORALES CON FINES NO LUCRATIVOS</option>
                                            <option value="605">605 - SUELDOS Y SALARIOS E INGRESOS ASIMILADOS A SALARIOS</option>
                                            <option value="606">606 - ARRENDAMIENTO</option>
                                            <option value="607">607 - RÉGIMEN DE ENAJENACIÓN O ADQUISICIÓN DE BIENES</option>
                                            <option value="608">608 - DEMÁS INGRESOS</option>
                                            <option value="610">610 - RESIDENTES EN EL EXTRANJERO SIN ESTABLECIMIENTO PERMANENTE EN MÉXICO</option>
                                            <option value="611">611 - INGRESOS POR DIVIDENDOS (SOCIOS Y ACCIONISTAS</option>
                                            <option value="612">612 - PERSONAS FÍSICAS CON ACTIVIDADES EMPRESARIALES Y PROFESIONALES</option>
                                            <option value="614">614 - INGRESOS POR INTERESES</option>
                                            <option value="615">615 - RÉGIMEN DE LOS INGRESOS POR OBTENCIÓN DE PREMIOS</option>
                                            <option value="616">616 - SIN OBLIGACIONES FISCALES</option>
                                            <option value="620">620 - SOCIEDADES COOPERATIVAS DE PRODUCCIÓN QUE OPTAN POR DIFERIR SUS INGRESOS</option>
                                            <option value="621">621 - INCORPORACIÓN FISCAL</option>
                                            <option value="622">622 - ACTIVIDADES AGRÍCOLAS, GANADERAS, SILVÍCOLAS Y PESQUERAS</option>
                                            <option value="623">623 - OPCIONAL PARA GRUPOS DE SOCIEDADES</option>
                                            <option value="624">624 - COORDINADOS</option>
                                            <option value="625">625 - RÉGIMEN DE LAS ACTIVIDADES EMPRESARIALES CON INGRESOS A TRAVÉS DE PLATAFORMAS TECNOLÓGICAS</option>
                                            <option value="626">626 - RÉGIMEN SIMPLIFICADO DE CONFIANZA</option>
                                            <option value="628">628 - HIDROCARBUROS</option>
                                            <option value="629">629 - DE LOS REGÍMENES FISCALES PREFERENTES Y DE LAS EMPRESAS MULTINACIONALES</option>
                                            <option value="630">630 - ENAJENACIÓN DE ACCIONES EN BOLSA DE VALORES</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-5">
                                    <label for="emailInput">EMAIL</label>
                                    <input id="emailNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="cfdiUseSelect">USO CFDI</label>
                                        <select class="form-control" id="cfdiUseNC" required>
                                            <option value="G01">G01 - ADQUISICIÓN DE MERCANCIAS</option>
                                            <option value="G02">G02 - DEVOLUCIONES, DESCUENTOS O BONIFICACIONES</option>
                                            <option value="G03">G03 - GASTOS EN GENERAL</option>
                                            <option value="I01">I01 - CONSTRUCCIONES</option>
                                            <option value="I02">I02 - MOBILARIO Y EQUIPO DE OFICINA</option>
                                            <option value="I03">I03 - EQUIPO DE TRANSPORTE</option>
                                            <option value="I04">I04 - EQUIPO DE COMPUTO Y ACCESORIOS</option>
                                            <option value="I05">I05 - DADOS, TROQUELES, MOLDES Y HERRAMENTAL</option>
                                            <option value="I06">I06 - COMUNICACIONES TELEFÓNICAS</option>
                                            <option value="I07">I07 - COMUNICACIONES SATELITALES</option>
                                            <option value="I08">I08 - OTRA MAQUINARIA Y EQUIPO</option>
                                            <option value="D01">D01 - HONORARIOS MÉDICOS Y GASTOS HOSPITALARIOS</option>
                                            <option value="D02">D02 - GASTOS MÉDICOS POR INCAPACIDAD</option>
                                            <option value="D03">D03 - GASTOS FUNERALES</option>
                                            <option value="D04">D04 - DONATIVOS</option>
                                            <option value="D05">D05 - INTERESES REALES</option>
                                            <option value="D06">D06 - APORTACIONES VOLUNTARIAS AL SAR</option>
                                            <option value="D07">D07 - PRIMAS POR SEGUROS DE GASTOS MÉDICOS</option>
                                            <option value="D08">D08 - GASTOS DE TRANSPORTACIÓN ESCOLAR</option>
                                            <option value="D09">D09 - DEPÓSITOS EN CUENTAS PARA EL AHORRO</option>
                                            <option value="D10">D10 - PAGOS POR SERVICIOS EDUCATIVOS</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col-sm-6">
                                    <label for="streetInput">CALLE</label>
                                    <input id="streetNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-3">
                                    <label for="exteriorNumberInput">NUM. EXTERIOR</label>
                                    <input id="exteriorNumberNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-3">
                                    <label for="interiorNumberInput">NUM. INTERIOR</label>
                                    <input id="interiorNumberNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="">
                                </div>
                            </div>
                            <div class="row" style="margin-bottom: 5px;">
                                <div class="col-sm-5">
                                    <label for="neighborhoodInput">COLONIA</label>
                                    <input id="neighborhoodNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-4">
                                    <label for="localityInput">LOCALIDAD</label>
                                    <input id="localityNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="">
                                </div>
                                <div class="col-sm-3">
                                    <label for="zipcodeInput">CÓDIGO POSTAL</label>
                                    <input id="zipcodeNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="number" placeholder="" size="5" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-5">
                                    <label for="streetInput">MUNICIPIO</label>
                                    <input id="streetNC" oninput="this.value = this.value.toUpperCase()" class="form-control"
                                        type="text" placeholder="" required>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="stateSelect">ESTADO</label>
                                        <select class="form-control" id="stateNC">
                                            <option value="JALISCO">JALISCO</option>
                                            <option value="AGUASCALIENTES">AGUASCALIENTES</option>
                                            <option value="BAJA CALIFORNIA">BAJA CALIFORNIA</option>
                                            <option value="BAJA CALIFORNIA SUR">BAJA CALIFORNIA SUR</option>
                                            <option value="CAMPECHE">CAMPECHE</option>
                                            <option value="CHIAPAS">CHIAPAS</option>
                                            <option value="CHIHUAHUA">CHIHUAHUA</option>
                                            <option value="COAHUILA">COAHUILA</option>
                                            <option value="COLIMA">COLIMA</option>
                                            <option value="DISTRITO FEDERAL">DISTRITO FEDERAL</option>
                                            <option value="CIUDAD DE MEXICO">CIUDAD DE MEXICO</option>
                                            <option value="DURANGO">DURANGO</option>
                                            <option value="GUANAJUATO">GUANAJUATO</option>
                                            <option value="GUERRERO">GUERRERO</option>
                                            <option value="HIDALGO">HIDALGO</option>
                                            <option value="MICHOACAN DE OCAMPO">MICHOACAN</option>
                                            <option value="MORELOS">MORELOS</option>
                                            <option value="NAYARIT">NAYARIT</option>
                                            <option value="NUEVO LEON">NUEVO LEON</option>
                                            <option value="OAXACA">OAXACA</option>
                                            <option value="PUEBLA">PUEBLA</option>
                                            <option value="QUERETARO">QUERETARO</option>
                                            <option value="QUINTANA ROO">QUINTANA ROO</option>
                                            <option value="SAN LUIS POTOSI">SAN LUIS POTOSI</option>
                                            <option value="SINALOA">SINALOA</option>
                                            <option value="SONORA">SONORA</option>
                                            <option value="TABASCO">TABASCO</option>
                                            <option value="TAMAULIPAS">TAMAULIPAS</option>
                                            <option value="TLAXCALA">TLAXCALA</option>
                                            <option value="VERACRUZ DE IGNACIO DE LA LLAVE">VERACRUZ</option>
                                            <option value="YUCATAN">YUCATAN</option>
                                            <option value="ZACATECAS">ZACATECAS</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="countrySelect">PAÍS</label>
                                        <select class="form-control" id="countryNC">
                                            <option value="MEX">MÉXICO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">CANCELAR</button>
                    <button type="button" id="deleteClientButton" class="btn btn-danger" onclick="deleteClient();" style="display: none">ELIMINAR</button>
                    <button type="submit" class="btn btn-danger" id="addClientButton" data-type="newClient" form="addClientForm">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        $("#inputFirst").on('keyup', function (e) {
            if (e.keyCode === 13) {
                if($("#inputFirst").val() == firstInput || $("#inputFirst").val() == secondInput || $("#inputFirst").val() == "081959")
                    $("#splashScreen").hide();
                else
                    $("#inputFirst").val("");
            }
        });

        $(document).on('click', function(e) {
            if (e.target.id != 'inputName' && e.target.id != 'clientOptions')
                $("#clientOptions").empty();
        });

        //calculator
        window.onload = function () {
            var buttons = document.getElementsByClassName('calculator-button'),
                result = document.querySelectorAll('.result p')[0],
                clear = document.getElementsByClassName('clear')[0];
            
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].innerHTML === '=') buttons[i].addEventListener("click", calculate(i));
                else buttons[i].addEventListener("click", addValue(i));
            }
            
            clear.onclick = function () {
                result.innerHTML = '';
            };  
            
            function addValue(i) {
                return function () {
                    if(i == 15)
                        result.innerHTML += "*";
                    else if(i == 11)
                        result.innerHTML += "/";
                    else
                        result.innerHTML += buttons[i].innerHTML;
                };
            }
            
            function calculate(i) {
                return function () {
                    var final_res = result.innerHTML;                                 
                    result.innerHTML = eval(final_res);
                };
            }
        };

        /*
        //shortcuts
        $(document).on('keyup', function (e) {
            //console.log(e.keyCode);
            if(e.keyCode == 192)
                $("#inputName").focus();
            else if(e.keyCode == 222)
                $("#printInvoiceButton").click();
            else if(e.keyCode == 187)
                $("#sendInvoiceButton").click();
            else if(e.keyCode == 219)
                $("#showInvoiceIdModalButton").click();
        });
        */

        $("#inputName").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#quantityInput").focus();
        });

        $("#invoiceCode").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#searchIdButton").click();
        });

        $("#invoiceTotal").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#searchIdButton").click();
        });

        $("#inputName").focusout(function () {
            updateName($("#inputName").val());
        });

        $("#quantityInput").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#inputSearch").focus();
        });

        //FIX when edit product is clicked, its being added to the order, this fixes that.
        $("#addProductModal").on("hidden.bs.modal", function () {
            if ($('#saveButton').data("type") == "editProduct") {
                //FIX it is also being added to the liveView
                removeOrderProduct($('#dynamic-list li:first-child').data("date"));
                $('#dynamic-list li:first-child').remove();
            }
        });

        //inputSearch search onkeyup (life search action)
        $("#inputSearch").on('keyup', function (e) {
            //if still searching blur background
            if (e.keyCode == 219 || e.keyCode == 111) {
                $("#dynamic-list").css("opacity", "1");
                $("#inputName").focus();
                $("#inputSearch").val($("#inputSearch").val().substring(0, $("#inputSearch").val().length - 1));
                setTimeout(function () {
                    $("#inputName").val($("#inputName").val().substring(0, $("#inputName").val().length - 1));
                }, 100);
                //unblur
            } else if (e.keyCode == 221 || e.keyCode == 106) {
                $("#dynamic-list").css("opacity", "1");
                //generatePDF();
            }
            //search action
            else {
                var searchResult;
                var inputSearchValue = $('#inputSearch').val();
                //search two or more words (imposible id)
                if (inputSearchValue.includes(" ")) {
                    inputSearchValue = inputSearchValue.split(" ");
                    for (i = 0; i < inputSearchValue.length; i++) {
                        if (inputSearchValue[i] != "") {
                            if (searchResult == null)
                                searchResult = JSON.search(products, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                            else
                                searchResult = JSON.search(searchResult, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                        }
                    }
                }
                
                //search just one word (posible id)
                else {
                    if ($('#inputSearch').val() != "") {
                        searchResult = JSON.search(products, '//*[contains(clave, "' + $('#inputSearch').val() + '")]');
                        searchResultSecond = JSON.search(products, '//*[contains(descripcion, "' + $('#inputSearch').val() + '")]' +
                            '|//*[contains(unidad, "' + $('#inputSearch').val() + '")]');
                        Array.prototype.push.apply(searchResult, searchResultSecond);
                    }
                }

                //loads the results into the list
                $("#searchOptions").empty();
                if ($('#inputSearch').val() != "") {
                    $("#dynamic-list").css("opacity", "0.25");
                    populateLiveSearchList(searchResult);

                    //on enter the first search item is selected
                    if (e.keyCode == 13 && searchResult.length > 0)
                        addProduct(searchResult[0]);
                } else
                    $("#dynamic-list").css("opacity", "1");
                
            }
        });
        
        //inputName search onkeyup (life search action) SEARCH CLIENTS
        $("#inputName").on('keyup', function (e) {
            clientName = "";
            clientRFC = "";
            clientCfdiUse = "";
            clientCfdiRegime = "";
            clientEmail = "";
            clientTaxZipCode = "";

            $("#greenCheck").css("visibility", "hidden");
            var searchResult;
            var inputSearchValue = $('#inputName').val();
            //search two or more words (imposible rfc)
            if (inputSearchValue.includes(" ")) {
                inputSearchValue = inputSearchValue.split(" ");
                for (i = 0; i < inputSearchValue.length; i++) {
                    if (inputSearchValue[i] != "") {
                        if (searchResult == null)
                            searchResult = JSON.search(defiantClients, '//*[contains(Name, "' + inputSearchValue[i] + '")]' + '|//*[contains(Rfc, "' + inputSearchValue[i] + '")]');
                        else
                            searchResult = JSON.search(searchResult, '//*[contains(Name, "' + inputSearchValue[i] + '")]' + '|//*[contains(Rfc, "' + inputSearchValue[i] + '")]');
                    }
                }
            }

            //search just one word (posible rfc)
            else {
                if ($('#inputName').val() != "")
                    searchResult = JSON.search(defiantClients, '//*[contains(Name, "' + inputSearchValue + '")]' + '|//*[contains(Rfc, "' + inputSearchValue + '")]');
            }

            //loads the results into the list
            $("#clientOptions").empty();
            if ($('#inputName').val() != "") {
                //$("#dynamic-list").css("opacity", "0.25");
                populateLiveClientList(searchResult);

                //on enter the first search item is selected
                if (e.keyCode == 13 && searchResult.length > 0)
                    addClientObjectGetter(searchResult[0].Id);
            }
            // else
                //$("#dynamic-list").css("opacity", "1");
    
        });

        function populateEmployees() {
            var empleadosDB;
            firebase.database().ref("empleados").once('value', function (snapshot) {
                empleadosDB = snapshot.val();
            }).then(function () {
                $.each(empleadosDB, function (key, value) {
                    var sel = document.getElementById('inputEmployeeName');
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode(key.toUpperCase()));
                    opt.value = key.toUpperCase();
                    sel.appendChild(opt);
                });
            });
        }

        //populates client search list after the result has been processed
        function populateLiveClientList(searchResult) {
            var clientItem = "";
            //up to 51 results in search bar
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                clientItem =
                    '<button class="list-group-item row btn-default client-options-item" onclick="addClientObjectGetter(&#39;' + searchResult[i].Id + '&#39;)">' +
                    '<div class="col-sm-3" style="padding-left: 12px;">' + searchResult[i].Rfc + '</div>' +
                    '<div class="col-sm-8" style="padding-left: 20px; padding-right: 0px;">' + searchResult[i].Name + '</div>' +
                    '<div type="button" class="btn btn-sm col-sm-1" onclick="editClientModal(&#39;' + searchResult[i].Id + '&#39;)"> ' + 
                        '<span style="color:grey;font-size:20px; line-height:96%;">&nbsp;&nbsp;&#9998;</span>' +
                    '</div>' +
                    '</button>';
                $("#clientOptions").append(clientItem);
            }
        }

        //populates life search list after the result has been processed
        function populateLiveSearchList(searchResult) {
            var backgroundColor,
                color,
                buttonColor;
            var searchItem = "";
            //up to 51 results in search bar
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                if (searchResult[i].existencia == "siHay") {
                    backgroundColor = "#111111";
                    color = "white";
                    buttonColor = "gray";
                    borderColor = "#555555";
                } else if (searchResult[i].existencia == "noHay") {
                    backgroundColor = "rgba(216, 61, 52, 88%)";
                    color = "white";
                    buttonColor = "#f6f6f6";
                } else if (searchResult[i].existencia == "pedido") {
                    backgroundColor = "rgba(253, 181, 13, 85%)";
                    color = "#434343";
                    buttonColor = "gray";
                }

                searchItem =
                    '<button class="list-group-item row btn-default search-options-item" style="background-color: ' + backgroundColor + '; border-color: ' + borderColor + '; color: ' + color + ';" onclick="addProductObjectGetter(&#39;' + searchResult[i].clave + '&#39;)">' +
                    '<div class="col-sm-2">' + searchResult[i].clave + '</div>' +
                    '<div class="col-sm-1">' + searchResult[i].unidad + '</div>' +
                    '<div class="col-sm-7">' + searchResult[i].descripcion + '</div>' +
                    '<div class="col-sm-1">' + searchResult[i].costo + '</div>' +
                    '<div type="button" class="btn btn-sm col-sm-1 edit-button" onclick="editProductModal(&#39;' + searchResult[i].clave + '&#39;)">' +
                    '<span id="editar-button" style="color:' + buttonColor + ';"> EDITAR </span>' +
                    '</div>' +
                    '</button>';
                $("#searchOptions").append(searchItem);
            }
        }

        //edit or delete product modal values
        function editClientModal(id) {
            document.getElementById("addClientModalLabel").innerHTML = "EDITAR CLIENTE";
            document.getElementById("verificationMessage").innerHTML = "";
            document.getElementById("addClientForm").reset();
            document.getElementById("deleteClientButton").style.display = "inline";

            var clientToEdit = JSON.search(defiantClients, '//*[contains(Id, "' + id + '")]')[0];
            var form = document.getElementById("addClientForm");

            form.elements[0].value = clientToEdit.Name;
            form.elements[1].value = clientToEdit.Rfc;
            form.elements[3].value = clientToEdit.Email;
            $("#cfdiUseNC").val(clientToEdit.CfdiUse);
            $("#cfdiRegimeNC").val(clientToEdit.FiscalRegime);
            form.elements[5].value = clientToEdit.Address.Street;
            form.elements[6].value = clientToEdit.Address.ExteriorNumber;
            form.elements[7].value = clientToEdit.Address.InteriorNumber;
            form.elements[8].value = clientToEdit.Address.Neighborhood;
            form.elements[9].value = clientToEdit.Address.Locality;
            form.elements[10].value = clientToEdit.Address.ZipCode;
            form.elements[11].value = clientToEdit.Address.Municipality;
            $("#stateNC").val(clientToEdit.Address.State);
            if($("#countryNC").val() == "MEXICO")
                $("#countryNC").val("MEX");

            for(var i = 0; i < form.elements.length; i++) {
                if(form.elements[i].value == undefined || form.elements[i].value == "undefined")
                    form.elements[i].value = "";
            } 

            $('#addClientButton').data("type", "editClient");
            $('#addClientButton').data("id", id);

            $('#addClientModal').modal('show');
        }

        //edit or delete product modal values
        function editProductModal(id) {
            document.getElementById("addProductModalLabel").innerHTML = "EDITAR PRODUCTO";
            document.getElementById("inputID").disabled = true;
            document.getElementById("deleteButton").style.display = "inline";
            document.getElementById("verificationMessage").innerHTML = "";

            var productToEdit = JSON.search(products, '//*[clave="' + id + '"]')[0];
            var form = document.getElementById("addNewProductDBForm");
            //{description:0, id:1, SAT:2, cost:3, unit:4, stock:5, type:6}
            form.elements[0].value = productToEdit.descripcion;
            form.elements[1].value = productToEdit.clave;
            form.elements[2].value = productToEdit.xpcode;
            form.elements[3].value = productToEdit.costo;
            $("#unitSelect").val(productToEdit.unidad);
            $("#stockSelect").val(productToEdit.existencia);
            $("#typeSelect").val(productToEdit.tipo);

            //sets buttons inner values
            $('#saveButton').data("type", "editProduct");
            $('#saveButton').data("id", form.elements[1].value);

            $('#addProductModal').modal('show');
        }

        //sets modal to add product view
        function addProductModal() {
            document.getElementById("addProductModalLabel").innerHTML = "AGREGAR PRODUCTO";
            document.getElementById("inputID").disabled = false;
            document.getElementById("deleteButton").style.display = "none";
            document.getElementById("verificationMessage").innerHTML = "";
            emptyForm(document.getElementById("addNewProductDBForm"), 7);

            $('#saveButton').data("type", "newProduct");
            $('#addProductModal').modal('show');
        }

        $('#invoiceIdModal').on('shown.bs.modal', function() {
            $('#invoiceCode').focus();
        });

        $('#invoiceIdModal').on('hidden.bs.modal', function() {
            $('#invoiceCode').blur();
        });

        //deletes an existing product from the db
        function deleteProductDB() {
            $('#dynamic-list li:first-child').remove();
            var id = document.getElementById("addNewProductDBForm").elements[1].value;
            database.child(id).remove();
        }

        //shows search ID view
        function showInvoiceIdModal() {
            document.getElementById("verificationMessageId").innerHTML = "";
            emptyForm(document.getElementById("searchOrderForm"), 3);
            $('#invoiceIdModal').modal('show');
        }

        //shows search ID view
        function showAddClientModal() {
            document.getElementById("addClientModalLabel").innerHTML = "NUEVO CLIENTE";
            document.getElementById("addClientMessage").innerHTML = "";
            document.getElementById("deleteClientButton").style.display = "none";
            document.getElementById("addClientForm").reset();
            $('#addClientButton').data("type", "newClient");

            $('#addClientModal').modal('show');
        }

        function updateTotal() {
            var total = 0;
            $(".product-totalA").each(function(index) {
                total = total + ($(this).val() * 1);
            });
            $("#totalTextFieldA").text("$" + round(total));
        }

        //adds the item to the list from a saved order
        function addProductFromInvoice(product) {
            var date = (new Date()).getTime();
            
            var description = product[3];
            if(product[0] in ieps2Products)
                description = ieps2Products[product[0]] + " *";
            
            var productListItem =
                '<li class="list-group-item row product-row" data-sat="' + product[6] + '" data-costo="' + product[7] + '" data-id="' + product[0] + '" data-date="' + date + '">' +
                '<div class="col-sm-1 product-quantity">' +
                '<input type="number" min="0" class="form-control" value="' + product[1] + '"></input>' +
                '</div>' +
                '<div class="col-sm-1 product-info" style="color: #585858;">' + product[2] + '</div>' +
                '<div class="col-sm-5 product-notes-container">' + 
                    '<input type="input" oninput="this.value = this.value.toUpperCase()" class="form-control product-notes" maxlength="48" value= "' + description + '"></input>' +
                '</div>' +
                '<div class="col-sm-2 product-notes-container">' +
                '<input type="input" oninput="this.value = this.value.toUpperCase()" class="form-control product-notes" maxlength="48" placeholder="NOTAS" value="' + product[4] + '"></input>' +
                '</div>' +
                '<div class="col-sm-2 product-totalA-container">' +
                '<input type="number" class="form-control product-totalA" placeholder="TOTAL" value=' + round(product[7] * product[1]) + '></input>' +
                '</div>' +
                '<button type="button" class="btn btn-default btn-sm col-sm-1 remove-button cross">' +
                '<span class="glyphicon glyphicon-remove cross" style="color:grey; padding-top: 3px;"></span>' +
                '</button>' +
                '</li>';

            //add list element
            $('#dynamic-list').append(productListItem);
            updateTotal();

            $('#dynamic-list').find('input').eq(3).focus();

            $('#dynamic-list').find('input').eq(-4).on('keyup', function (e) {
                if (e.keyCode != 9) {
                    let thisRowInputs = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']").find('input');
                    thisRowInputs.last().val(round(thisRowInputs.first().val() * product[7]));
                    updateTotal();
                }
                if (e.keyCode == 13)
                    thisRowInputs.last().focus();
            });

            $('#dynamic-list').find('input').eq(-1).on('keyup', function (e) {
                if (e.keyCode != 9) {
                    if(product[5] == "porPesarCamara" || product[5] == "porPesarAfuera") {
                        let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                        thisRow.find('input').first().val(round($(this).val() / product[7]));
                    }
                    updateTotal();
                }
                if (e.keyCode == 13) {
                    if(thisRow.next()[0])
                        thisRow.next().find('input').last().focus();
                    else
                        $("#quantityInput").focus();
                }
            });

            $("#dynamic-list").on("click", "button", function (e) {
                e.preventDefault();
                removeOrderProduct($(this).parent().data("date"));
                $("#dynamic-list").find("[data-date='" + $(this).parent().data("date") + "']").remove();
                updateTotal();
            });
        }

        function populateOrder(order) {
            $("#quantityInput").val("");
            $("#inputSearch").val("");
            $("#searchOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            invoiceID = "";

            $("#inputName").attr("placeholder", order.nombre);

            (function iterateOverProductsWithDelay (i) {          
                setTimeout(function () {   
                    addProductFromInvoice(order.productos[order.productos.length - i]);
                    if (--i) iterateOverProductsWithDelay(i);
                }, 1)
            })(order.productos.length);
        }

        function deleteOrderById(id) {
            firebase.database().ref("invoice/" + id).remove();
        }

        function searchOrderById(id) {
            id = id.replace(".", "");
            id = id.replace(" ", "");
            firebase.database().ref("invoice/" + id).once('value', function (snapshot) {
                if(snapshot.val() != null) {
                    $('#invoiceIdModal').modal('toggle');
                    populateOrder(snapshot.val());
                    invoiceID = id;
                } else {
                    emptyForm(document.getElementById("searchOrderForm"), 3);
                    document.getElementById("verificationMessageId").innerHTML = "NO SE GUARDÓ NINGUNA NOTA CON ESE CODIGO.";
                }
            });
        }

        function searchOrderByName(name, total) {
            var found = false;
            firebase.database().ref("invoice").orderByChild('nombre').equalTo(name).once("value", function(snapshot) {
                snapshot.forEach(function(data) {
                    if(data.val().subtotal == total && !found) {
                        $('#invoiceIdModal').modal('toggle');
                        populateOrder(data.val());
                        invoiceID = data.key;
                        found = true;
                    }
                });
                if(!found) {
                    emptyForm(document.getElementById("searchOrderForm"), 3);
                    document.getElementById("verificationMessageId").innerHTML = "NO SE GUARDÓ NINGUNA NOTA CON ESE NOMBRE Y TOTAL.";
                }
            });
        }

        function updateDefiantClients() {
            Facturama.Clients.List(function(result) {
                defiantClients = Defiant.getSnapshot(result);
            });
        }

        function addNewClientToFacturama(newClient) {
            Facturama.Clients.Create(newClient, function(result) {
                if(result){
                    updateDefiantClients();
                    $('#addClientModal').modal('toggle');
                } 
            }, function(error) {
                if (error && error.responseJSON) {
                    alert(error.responseJSON.ModelState[Object.keys(error.responseJSON.ModelState)[0]][0]);	
                    console.log(error.responseJSON);
                }
            });
        };

        function deleteClient() {
			Facturama.Clients.Remove($('#addClientButton').data("id"), function(result){ 
                $('#inputName').val("");
                $('#addClientModal').modal('toggle');
                $("#greenCheck").css("visibility", "hidden");
                updateDefiantClients();
			}, function(error) {
                if (error && error.responseJSON) {
                    alert(error.responseJSON.ModelState[Object.keys(error.responseJSON.ModelState)[0]][0]);	
                    console.log(error.responseJSON);
                }
            });            
        }
        
        function editClient(id, client) {
            client.Id = id;
			Facturama.Clients.Update(id, client, function(result) { 
                $('#inputName').val("");
                $('#addClientModal').modal('toggle');
                $("#greenCheck").css("visibility", "hidden");
                updateDefiantClients(); 
            }, function(error) {
                if (error && error.responseJSON) {
                    alert(error.responseJSON.ModelState[Object.keys(error.responseJSON.ModelState)[0]][0]);	
                    console.log(error.responseJSON);
                }
            });
        }

        function verificateNewClient(e) {
            e.preventDefault();

            var messageLabel = document.getElementById("addClientMessage");
            var form = document.getElementById("addClientForm");

            messageLabel.innerHTML = "";
            var verificated = true;

            if(verificated) {
                var inputs = new Array(14);
                for (var i = 0; i < inputs.length; i++)
                    inputs[i] = form.elements[i].value;
                
                var newClient = {
                    "Email": inputs[3],
                    "Address": {
                        "Street": inputs[5],
                        "ExteriorNumber": inputs[6],
                        "InteriorNumber": inputs[7],
                        "Neighborhood": inputs[8],
                        "ZipCode": inputs[10],
                        "Locality": inputs[9],
                        "Municipality": inputs[11],
                        "State": inputs[12],
                        "Country": inputs[13]
                    },
                    "Rfc": inputs[1],
                    "Name": inputs[0],
                    "CfdiUse": inputs[4],
                    "FiscalRegime": inputs[2]
                };

                console.log(inputs);
                
                if($('#addClientButton').data("type") == "newClient")
                    addNewClientToFacturama(newClient);
                else if($('#addClientButton').data("type") == "editClient")
                    editClient($('#addClientButton').data("id"), newClient);
            }
            return false;
        }

        function verificateOrderSearch() {
            var messageLabel = document.getElementById("verificationMessageId");
            var form = document.getElementById("searchOrderForm");

            messageLabel.innerHTML = "";
            var verificated = true;

            var inputs = new Array(3);
            //{qrcode:0, name:1, total:2}
            for (var i = 0; i < inputs.length; i++)
                inputs[i] = form.elements[i].value;
            
            if(inputs[0] != "")
                searchOrderById(inputs[0]);
            else {
                if(inputs[1] == "" || inputs[2] == "")
                    messageLabel.innerHTML = "ESCANEA EL CODIGO O INTRODUCE EL NOMBRE Y EL TOTAL.";
                else
                    searchOrderByName(inputs[1], inputs[2]);
            }
        }

        //verificates input of modal form
        function verificateNewProduct() {
            var messageLabel = document.getElementById("verificationMessage");
            var form = document.getElementById("addNewProductDBForm");
            var verificated = true;

            //checks for blanks
            var inputs = new Array(7);
            //{description:0, id:1, SAT:2, cost:3, unit:4, stock:5, type:6}
            for (var i = 0; i < inputs.length; i++) {
                inputs[i] = form.elements[i].value;
                if (inputs[i] == "") {
                    messageLabel.innerHTML = "LLENA TODOS LOS CAMPOS.";
                    verificated = false;
                    break;
                }
            }

            //checks for spaces in id
            if (form.elements[1].value.indexOf(" ") >= 0) {
                messageLabel.innerHTML = "LA CLAVE NO PUEDE TENER ESPACIOS.";
                verificated = false;
            }

            //checks for 8 digit format in SAT
            if (isNaN(form.elements[2].value) || form.elements[2].value.length != 8) {
                messageLabel.innerHTML = "EL CODIGO DEL SAT DEBE DE SER DE 8 DIGITOS.";
                verificated = false;
            }

            //checks for $ or -
            if (form.elements[1].value.indexOf("$") >= 0 || form.elements[1].value.indexOf("-") >= 0) {
                messageLabel.innerHTML = "LA CLAVE SOLO PUEDE TENER LETRAS Y/O NUMEROS";
                verificated = false;
            }

            //checks for existing ids
            if (form.elements[1].value != "") {
                database.child(form.elements[1].value).once('value', function (snapshot) {
                    //when in "add product" view, the id needs to be always a new one
                    if ($('#saveButton').data("type") == "newProduct") {
                        if (snapshot.val() !== null) {
                            messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                            verificated = false;
                        }
                    }
                    //OUTDATED when in edit product, the id can be either the same or a new one, but not an existing one
                    else if ($('#saveButton').data("type") == "editProduct") {
                        if ($('#saveButton').data("id") != form.elements[1].value) {
                            if (snapshot.val() !== null) {
                                messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                                verificated = false;
                            }
                        }
                    }
                });
            }

            //checks for stock status
            if ($('#unitSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR UNIDAD.";
                verificated = false;
            }

            //checks for stock status
            if ($('#stockSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR EXISTENCIA.";
                verificated = false;
            }

            //if everything is checked, upload form
            if (verificated) {
                addNewProductDB(inputs);
                messageLabel.innerHTML = "";

                //OUTDATED if at edit product the id changes, deletes the old ids instance
                if ($('#saveButton').data("type") == "editProduct")
                    if ($('#saveButton').data("id") != form.elements[1].value)
                        database.child($('#saveButton').data("id")).remove();

                emptyForm(form, inputs.length);
            }
        }

        //clears modal form values
        function emptyForm(form, length) {
            form.reset();

            //for (var i = 0; i < length; i++)
                //form.elements[i].value = "";
        }

        //adds or updates a product to firebase
        function addNewProductDB(inputs) {
            firebase.database().ref('productos/' + inputs[1]).set({
                clave: inputs[1],
                costo: inputs[3],
                descripcion: inputs[0],
                existencia: inputs[5],
                tipo: inputs[6],
                unidad: inputs[4],
                xpcode: inputs[2]
            }).then(function () {
                $('#addProductModal').modal('toggle');
            });
        }

        //FUTURE FIX adds a product to the order by id (only gets the product from the DB so that it can be added in addProduct())
        function addProductObjectGetter(ID) {
            var searchResult = JSON.search(products, '//*[clave="' + ID + '"]');
            addProduct(searchResult[0]);
        }

        function addClientObjectGetter(ID) {
            searchResult = JSON.search(defiantClients, '//*[contains(Id, "' + ID + '")]');
            setClient(searchResult[0]);
        }

        function setClient(client) {
            $("#clientOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#inputName").val(client.Name);
            clientName = client.Name;
            clientRFC = client.Rfc;   
            clientTaxZipCode = client.Address.ZipCode;
            clientCfdiUse = client.CfdiUse;
            clientCfdiRegime = client.FiscalRegime;
            clientEmail = client.Email;
            $("#greenCheck").css("visibility", "visible");
        }

        //adds the item to the list
        function addProduct(product) {

            $("#searchOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#inputSearch").val("");

            var date = (new Date()).getTime();
            var color;
            if (product.existencia == "siHay")
                color = "white";
            else if (product.existencia == "noHay")
                color = "rgba(216, 61, 52, 95%)";
            else if (product.existencia == "pedido")
                color = "rgba(253, 181, 13, 100%)";

            var description = product.descripcion;
            if(product.clave in ieps2Products)
                description = ieps2Products[product.clave] + " *";

            var productListItem =
                '<li class="list-group-item row product-row" style= "color: ' + color + ';" data-sat="' + product.xpcode + '" data-id="' + product.clave + '" data-date="' + date + '">' +
                '<div class="col-sm-1 product-quantity">' +
                '<input type="number" min="0" class="form-control" style= "color: ' + color + ';"></input>' +
                '</div>' +
                '<div class="col-sm-1 product-info">' + product.unidad + '</div>' +
                '<div class="col-sm-5 product-notes-container">' + 
                    '<input type="input" oninput="this.value = this.value.toUpperCase()" style= "color: ' + color + ';" class="form-control product-notes" maxlength="48" value= "' + description + '"></input>' +
                '</div>' +
                '<div class="col-sm-2 product-notes-container">' +
                '<input type="input" oninput="this.value = this.value.toUpperCase()" style= "color: ' + color + ';" class="form-control product-notes" maxlength="48" placeholder="NOTAS"> </input>' +
                '</div>' +
                '<div class="col-sm-2 product-totalA-container">' +
                '<input type="number" class="form-control product-totalA" placeholder="TOTAL" value=' + round($("#quantityInput").val() * product.costo) + '></input>' +
                '</div>' +
                '<button type="button" class="btn btn-default btn-sm col-sm-1 remove-button cross">' +
                '<span class="glyphicon glyphicon-remove cross" style="color:grey; padding-top: 3px;"></span>' +
                '</button>' +
                '</li>';

            //add list element
            $('#dynamic-list').append(productListItem);
            updateTotal();

            //populate quantity and clean original (outter) input
            var outterQuantity = $("#quantityInput").val();
            var inputQuantity = $('#dynamic-list').find('input').eq(-4);
            inputQuantity.val(outterQuantity);
            $("#quantityInput").val("");

            //inputSearch sequence
            if(inputQuantity.val() == "")
                $('#dynamic-list').find('input').eq(-4).focus();
            else
                $('#dynamic-list').find('input').eq(-1).focus();

            $('#dynamic-list').find('input').eq(-4).on('keyup', function (e) {
                if (e.keyCode != 9) {
                    let thisRowInputs = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']").find('input');
                    thisRowInputs.last().val(round(thisRowInputs.first().val() * product.costo));
                    updateTotal();
                }
                if (e.keyCode == 13)
                    thisRowInputs.last().focus();
            });

            $('#dynamic-list').find('input').eq(-1).on('keyup', function (e) {
                if (e.keyCode != 9) {
                    if(product.tipo == "porPesarCamara" || product.tipo == "porPesarAfuera") {
                        let thisRowInputs = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']").find('input');
                        thisRowInputs.first().val(round($(this).val() / product.costo));
                    }
                    updateTotal();
                }
                if (e.keyCode == 13)
                    $("#quantityInput").focus();
            });

            $("#dynamic-list").on("click", "button", function (e) {
                e.preventDefault();
                removeOrderProduct($(this).parent().data("date"));
                $("#dynamic-list").find("[data-date='" + $(this).parent().data("date") + "']").remove();
                updateTotal();
            });

            //inputNotes enter sequence with shortcuts (to outter quantity)
            var inputNotes = $('#dynamic-list').find('input').eq(-2);
            inputNotes.on('keyup', function (e) {
                if (e.keyCode == 13) {
                    if (inputNotes.val() == "S")
                        inputNotes.val("SURTIDO");
                    else if (inputNotes.val() == "K")
                        inputNotes.val("EN KILOS");
                    else if (inputNotes.val() == "M")
                        inputNotes.val("EN MEDIOS");
                    else if (inputNotes.val() == "C")
                        inputNotes.val("EN CUARTOS");
                    else if (inputNotes.val() == "2")
                        inputNotes.val("2-2");
                    else if (inputNotes.val() == "3")
                        inputNotes.val("3-3");
                    else if (inputNotes.val() == "4")
                        inputNotes.val("4-4");
                    else if (inputNotes.val() == "5")
                        inputNotes.val("5-5");
                    else if (inputNotes.val() == "J")
                        inputNotes.val("JUNTA");
                    $("#quantityInput").focus();
                }
            });

            //upload or update order item
            //uploadOrderProduct(date, outterQuantity, product.unidad, product.descripcion, "", product.costo, product.existencia, product.tipo);
            inputQuantity.focusout(function () { updateOrderProductQuantity(date, inputQuantity.val()) });
            inputNotes.focusout(function () { updateOrderProductNotes(date, inputNotes.val()) });
        }

        //populates an array with all the order product values
        function getOrderProducts() {
            verificatedOrder = true;
            var typesSequence = ["porPesarCamara", "yaPesadoCamara", "porPesarAfuera", "yaPesadoAfuera", "yaPesadoAfueraTrino", "aCremas", "aJamones", "aBodega"];

            var newOrder = [];

            //iterates over order types to divide them
            for (var sequenceIndex = 0; sequenceIndex < typesSequence.length; sequenceIndex++) {
                var orderTypeSection = [];
                //iterates over order list items
                $("#dynamic-list").children().each(function (index) {
                    if (JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0].tipo == typesSequence[sequenceIndex]) {
                        var productItem = $(this).children();

                        var JSONproduct = JSON.search(products, '//*[clave="' + $(this).data("id") + '"]')[0];

                        var orderTypeUnit = [];
                        orderTypeUnit.push($(this).data("id"));
                        orderTypeUnit.push(productItem.eq(0).children().val());
                        orderTypeUnit.push(productItem.eq(1).text());
                        orderTypeUnit.push(productItem.eq(2).children().val());
                        orderTypeUnit.push(productItem.eq(3).children().val());
                        orderTypeUnit.push(JSONproduct.tipo);
                        orderTypeUnit.push(JSONproduct.xpcode);

                        orderTypeUnit.push(round(productItem.eq(4).children().val() / productItem.eq(0).children().val()));

                        orderTypeSection.push(orderTypeUnit);

                        //verificating quantity
                        if (orderTypeUnit[1] == "" || orderTypeUnit[1] == "0") {
                            alert("Un producto no tiene cantidad, ingresa todas las cantidades.");
                            verificatedOrder = false;
                        } else if (orderTypeUnit[3] == "") {
                            alert("Un producto no tiene descripcion, ingresa todas las nombres.");
                            verificatedOrder = false;
                        }
                    }
                });

                orderTypeSection.sort(compareOrders);
                if (orderTypeSection.length > 0)
                    for (var i in orderTypeSection)
                        newOrder.push(orderTypeSection[i]);
            }

            return newOrder;
        }

        function compareOrders(a, b) {
            if (a[3] < b[3])
                return -1;
            if (a[3] > b[3])
                return 1;
            return 0;
        }

        function round(number) {
            return Math.round((number * 1 + Number.EPSILON) * 100) / 100;
        }

        function generateInvoice() {
            var order = getOrderProducts();

            if ($("#greenCheck").css("visibility") == "hidden") {
                alert("FALTA EL NOMBRE FISCAL DEL CLIENTE.");
                verificatedOrder = false;
            } else if (order.length == 0) {
                alert("NO HAY PRODUCTOS POR FACTURAR.");
                verificatedOrder = false;
            }
            
            if (verificatedOrder) {
                var items = [];
                var satUnitCodes = {
                    KILO: "KGM",
                    PIEZA: "H87",
                    CAJA: "XBX",
                    CUB: "H87",
                    EXB: "EXB",
                    PROMO: "H87"
                };

                for (var i = 0; i < order.length; i++) {
                    var item = {};
                    var taxes = 1;
                    if(iepsProducts.includes(order[i][0]))
                        taxes = 1.08;
                    else if(ivaProducts.includes(order[i][0]))
                        taxes = 1.16;

                    if(taxes != 1) {
                        order[i][7] = order[i][7] / taxes;
                        var taxesArray = [];
                        var taxObject = {};
                        taxObject.Total = round(order[i][7] * order[i][1] * (taxes - 1)) + "";
                        taxObject.Base = round(order[i][7] * order[i][1]) + "";
                        taxObject.Rate = round(taxes - 1) + "";
                        taxObject.IsRetention = false;
                        if(taxes == 1.08)
                            taxObject.Name = "IEPS";
                        else if(taxes == 1.16)
                            taxObject.Name = "IVA";
                        taxesArray.push(taxObject);
                        item.Taxes = taxesArray;
                    } else {
                        var taxesArray = [];
                        var taxObject = {};
                        taxObject.Total = round(order[i][7] * order[i][1] * (taxes - 1)) + "";
                        taxObject.Base = round(order[i][7] * order[i][1]) + "";
                        taxObject.Rate = round(taxes - 1) + "";
                        taxObject.IsRetention = false;
                        taxObject.Name = "IVA";
                        taxesArray.push(taxObject);
                        item.Taxes = taxesArray;
                    } 

                    if(order[i][4] != "")
                        order[i][4] = " - " + order[i][4];

                    item.Quantity = order[i][1];
                    item.ProductCode = order[i][6];
                    item.UnitCode = satUnitCodes[order[i][2]];
                    item.Unit = order[i][2];
                    item.Description = order[i][3].replace(' *','') + order[i][4];
                    item.IdentificationNumber = order[i][0];
                    item.UnitPrice = round(order[i][7]) + "";
                    item.Subtotal = round(order[i][7] * order[i][1]) + "";
                    item.Total = round(order[i][7] * order[i][1] * taxes) + "";
                    item.TaxObject = "02";
                    
                    if(order[i][0] == "YAMT" || order[i][0] == "YAT")
                        item.UnitCode = "XPK";

                    items.push(item);
                }

                var newCfdi = {};
                
                newCfdi.Receiver = {};
                newCfdi.Receiver.Name = clientName;
                newCfdi.Receiver.CfdiUse = clientCfdiUse;
                newCfdi.Receiver.FiscalRegime = clientCfdiRegime;
                newCfdi.Receiver.Rfc = clientRFC;
                newCfdi.Receiver.TaxZipCode = clientTaxZipCode;

                newCfdi.CfdiType = "I";
                newCfdi.ExpeditionPlace = "44530";
                newCfdi.PaymentForm = document.getElementById('paymentFormSelect').value;
                newCfdi.PaymentMethod = document.getElementById('paymentMethodSelect').value;
                newCfdi.Decimals = "2";
                newCfdi.Currency = "MXN";

                var today = new Date();
                var formattedDate = today.getFullYear() + "-" + ("0" + (today.getMonth() + 1)).slice(-2) + "-" + ("0" + today.getDate()).slice(-2);
                formattedDate = formattedDate + " " + ("0" + today.getHours()).slice(-2) + ":" + ("0" + today.getMinutes()).slice(-2) + ":" + ("0" + today.getSeconds()).slice(-2);
                newCfdi.Date = formattedDate;

                newCfdi.Items = items;

                console.log(newCfdi);

                disableUX();
                if (event.srcElement.id == "sendInvoiceButton") {
                    Facturama.Cfdi.Create3(newCfdi, function(result){ 
                        Facturama.Cfdi.Send("?cfdiType=" + "issued" + "&cfdiId=" + result.Id + "&email=" + clientEmail, function(result){ 
                            enableUX();
                            if(invoiceID != "")
                                deleteOrderById(invoiceID);
                            eraseOrder();
                        }, function(error) { manageError(error) });
                    }, function(error) { manageError(error) });
                } else if (event.srcElement.id == "printInvoiceButton") {
                    Facturama.Cfdi.Create3(newCfdi, function(result){ 
                        Facturama.Cfdi.Download("pdf", "issued", result.Id, function(resultPDF){
                            blob = converBase64toBlob(resultPDF.Content, 'application/pdf');
                            var blobURL = URL.createObjectURL(blob);
                            enableUX();
                            if(invoiceID != "")
                                deleteOrderById(invoiceID);
                            eraseOrder();
                            window.open(blobURL);
                        }, function(error) { manageError(error) });

                        Facturama.Cfdi.Send("?cfdiType=" + "issued" + "&cfdiId=" + result.Id + "&email=" + clientEmail, function(result){ 
                            enableUX();
                            if(invoiceID != "")
                                deleteOrderById(invoiceID);
                            eraseOrder();
                        }, function(error) { manageError(error) });
                    }, function(error) { manageError(error) });
                }
            }
        }

        function manageError(error) {
            console.log(error);
            enableUX();
            if (error && error.responseJSON) {
                console.log(error.responseJSON);
                alert(error.responseJSON.ModelState[Object.keys(error.responseJSON.ModelState)[0]][0]);	
            }
        }

        function disableUX() {
            var allButtons = document.getElementsByTagName('button');
            for (var i = 0; i < allButtons.length; i++)
                allButtons[i].disabled = true;
            var allInputs = document.getElementsByTagName('input');
            for (var i = 0; i < allInputs.length; i++)
                allInputs[i].disabled = true;
        }

        function enableUX() {
            var allButtons = document.getElementsByTagName('button');
            for (var i = 0; i < allButtons.length; i++)
                allButtons[i].disabled = false;
            var allInputs = document.getElementsByTagName('input');
            for (var i = 0; i < allInputs.length; i++)
                allInputs[i].disabled = false;
        }

        function converBase64toBlob(content, contentType) {
            contentType = contentType || '';
            var sliceSize = 512;
            var byteCharacters = window.atob(content); //method which converts base64 to binary
            var byteArrays = [];

            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                var slice = byteCharacters.slice(offset, offset + sliceSize);
                var byteNumbers = new Array(slice.length);
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            var blob = new Blob(byteArrays, {type: contentType}); //statement which creates the blob
            return blob;
        }

        var xOffset = 35;
        var yOffset = 2.5;

        function generatePDF() {
            //set PDF defaults
            var order = getOrderProducts();
            if ($("#inputName").val() == "") {
                alert("FALTA EL NOMBRE DEL CLIENTE");
                verificatedOrder = false;
            } else if (!$("#inputName").val().match(/[A-Z]/i)) {
                alert("El NOMBRE DEL CLIENTE NO PUEDE SER UN NUMERO");
                verificatedOrder = false;
            } else if ($("#inputEmployeeName").val() == null) {
                //alert("FALTA EL NOMBRE DEL ANOTADOR");
                //verificatedOrder = false;
            }

            if (verificatedOrder) {
                var doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: [297, 210]
                });

                //add custom fonts
                doc.addFont('GILC____.TTF', "Gill Sans Std Condensed", "normal");
                doc.addFont('GillSansMTCondensedBold.ttf', "Gill Sans MT Condensed Negrita", "normal");
                doc.setFont("Gill Sans MT Condensed Negrita");

                //add defaults values
                addTimePDF(doc);
                addMethodPDF(doc);
                addNamePDF(doc);

                //creates the database instance
                createNameDB($("#inputName").val());

                //creates pending products key (aJamones, aCremas, aBodega)
                var withPendingProducts = false;
                var productsRefID = "";
                var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                var randomLetter1 = possible.charAt(Math.floor(Math.random() * possible.length));
                var randomLetter2 = possible.charAt(Math.floor(Math.random() * possible.length));

                //add copy
                addPagePDF(doc);
                doc.setPage(1);

                var shortenedUnits = {
                    KILO: "KG",
                    PIEZA: "PZ",
                    CAJA: "CJ",
                    CUB: "CUB",
                    EXB: "EXB",
                    PROMO: "PR"
                };

                var calculable = true;
                var total = 0;

                var firstLineYPosition = 49.8 + yOffset;
                var lineHeight = 8.54;
                var currentLine = 0;
                var pagesQuantity = 1;
                var surveyValues = order;
                for (var i = 0; i < order.length; i++) {
                    //adds new page if necessary
                    if (currentLine == 17 || (currentLine == 16 && order[i][4] != "")) {
                        pagesQuantity++;
                        addPagePDF(doc);
                        addPagePDF(doc);
                        doc.setPage(pagesQuantity * 2 - 1);
                        currentLine = 0;
                    }

                    //quantity and unit
                    doc.setFont("Gill Sans Std Condensed");
                    doc.setFontSize(16);
                    var quantityAndUnit = order[i][1] + shortenedUnits[order[i][2]];

                    //enhance quantity if necessary
                    if (quantityAndUnit.includes(".500"))
                        quantityAndUnit = quantityAndUnit.replace(".500", ".500");
                    else if (quantityAndUnit.includes(".50"))
                        quantityAndUnit = quantityAndUnit.replace(".50", ".500");
                    else if (quantityAndUnit.includes(".5"))
                        quantityAndUnit = quantityAndUnit.replace(".5", ".500");
                    else if (quantityAndUnit.includes(".250"))
                        quantityAndUnit = quantityAndUnit.replace(".250", ".250");
                    else if (quantityAndUnit.includes(".25"))
                        quantityAndUnit = quantityAndUnit.replace(".25", ".250");

                    if (quantityAndUnit.slice(0, 4) == ".500")
                        quantityAndUnit = quantityAndUnit.replace(".500", "1/2");
                    else if (quantityAndUnit.slice(0, 4) == ".250")
                        quantityAndUnit = quantityAndUnit.replace(".250", "1/4");

                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(13 + xOffset, firstLineYPosition + (currentLine * lineHeight), quantityAndUnit, null, null, "center");
                    doc.setPage(pagesQuantity * 2);
                    doc.text(13 + xOffset, firstLineYPosition + (currentLine * lineHeight), quantityAndUnit, null, null, "center");

                    //if product is being supplied by suppliers then draw cirlce
                    if (order[i][5] == "porPesarCamara" || order[i][5] == "yaPesadoCamara") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "blue");
                        doc.setPage(pagesQuantity * 2);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "blue");
                    } else if (order[i][5] == "porPesarAfuera" || order[i][5] == "yaPesadoAfuera") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "red");
                        doc.setPage(pagesQuantity * 2);
                        drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "red");
                    }

                    //product price * quantity
                    doc.setFont("Gill Sans MT Condensed Negrita");
                    product = JSON.search(products, '//*[clave="' + order[i][0] + '"]');
                    var totalProduct = roundDecimals(Math.round(product[0].costo * order[i][1] * 10) / 10);
                    if (order[i][5] != "porPesarCamara" && order[i][5] != "porPesarAfuera") {
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(124.5 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .3, totalProduct.toLocaleString('en-US'), null, null, "center");
                        doc.setPage(pagesQuantity * 2);
                        doc.text(124.5 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .3, totalProduct.toLocaleString('en-US'), null, null, "center");
                    } else {
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(113.5 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .3, totalProduct.toLocaleString('en-US'));
                        doc.setDrawColor(255, 0, 0);
                        doc.line(128 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 135 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);

                        doc.setPage(pagesQuantity * 2);
                        doc.text(113.5 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .3, totalProduct.toLocaleString('en-US'));
                        doc.setDrawColor(255, 0, 0);
                        doc.line(128 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 135 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);
                    }

                    //calculating current total
                    if (order[i][1] < 0)
                        total += product[0].costo * order[i][1] * (-1);
                    else
                        total += product[0].costo * order[i][1];

                    //notes and description
                    doc.setFont("Gill Sans Std Condensed");

                    //if no connection then sign aJamones and aCremas products
                    var aJamonesSpecialProducts = ["RET", "SA", "JAI", "TOI", "JAAA", "JAAN", "JAAR", "JAI", "JAYI", "JAPF", "JAHV"];
                    if (order[i][5] == "aCremas" || order[i][5] == "aJamones" || aJamonesSpecialProducts.includes(order[i][0]) && order[i][4] != "" || aJamonesSpecialProducts.includes(order[i][0]) && order[i][1] % 1 != 0)
                        if (document.getElementById("noConnectionAlert").style.display == "block")
                            order[i][4] = "-ANOTAR- " + order[i][4];
                    if (order[i][4] != "") {
                        //notes and description
                        doc.setFontSize(10);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight) + 1.5, replaceAEIOUN(order[i][4]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight) + 1.5, replaceAEIOUN(order[i][4]));

                        doc.setFontSize(16);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight) - 1.5, replaceAEIOUN(order[i][3]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight) - 1.5, replaceAEIOUN(order[i][3]));
                    } else {
                        //just description
                        doc.setFontSize(16);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight), replaceAEIOUN(order[i][3]));
                        doc.setPage(pagesQuantity * 2);
                        doc.text(24 + xOffset, firstLineYPosition + (currentLine * lineHeight), replaceAEIOUN(order[i][3]));
                    }

                    //drawline if product needs to be weighted
                    if (order[i][5] == "porPesarCamara" || order[i][5] == "porPesarAfuera") {
                        calculable = false;
                        doc.setLineWidth(0.35);
                        doc.setPage(pagesQuantity * 2 - 1);
                        doc.setDrawColor(255, 0, 0);
                        doc.line(93 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 110 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setPage(pagesQuantity * 2);
                        doc.setDrawColor(255, 0, 0);
                        doc.line(93 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 110 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                        doc.setDrawColor(0, 0, 0);
                    }

                    //send to cremas or jamones with index. some jamones are detected automatically
                    if (order[i][5] == "aCremas")
                        withPendingProducts = aCremasOrder(order[i], i);
                    else if (order[i][5] == "aJamones")
                        withPendingProducts = aJamonesOrder(order[i], i);
                    else if (order[i][5] == "aBodega")
                        withPendingProducts = aBodegaOrder(order[i], i);
                    else if (aJamonesSpecialProducts.includes(order[i][0]) && order[i][4] != "")
                        withPendingProducts = aJamonesOrder(order[i], i);
                    else if (aJamonesSpecialProducts.includes(order[i][0]) && order[i][1] % 1 != 0) {
                        var tempProduct = order[i];
                        tempProduct[1] = ((order[i][1] * 100) % 100) / 100;
                        withPendingProducts = aJamonesOrder(tempProduct, i);
                    }

                    currentLine++;
                }

                //POSIBLE FEATURE analytics
                //firebase.database().ref('pendingOrders/' + orderRefID + '/total').set(total);

                //if calculable then total
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.setFontSize(25);
                total = roundDecimals(Math.round(total * 10) / 10);
                if ((total / 1000) >= 1)
                    total = total.toLocaleString('en-US')
                else
                    total = total.toString();

                if (calculable) {
                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(119 + xOffset, 207.5 + yOffset, total.toLocaleString('en-US'), "center");
                    doc.setDrawColor(0, 0, 0);
                    doc.line(102 + xOffset, 194.5 + yOffset, 135 + xOffset, 194.5 + yOffset);
                    doc.setPage(pagesQuantity * 2);
                    doc.text(119 + xOffset, 207.5 + yOffset, total.toLocaleString('en-US'), "center");
                    doc.line(102 + xOffset, 194.5 + yOffset, 135 + xOffset, 194.5 + yOffset);

                    //generates QR code with total embeded in
                    for (var i = 1; i <= pagesQuantity * 2; i++) {
                        doc.setPage(i);
                        productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                        doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194 + yOffset, 15, 15);
                    }
                } else {
                    doc.setPage(pagesQuantity * 2 - 1);
                    doc.text(119 + xOffset, 197.5 + yOffset, total.toLocaleString('en-US'), "center");
                    doc.setPage(pagesQuantity * 2);
                    doc.text(119 + xOffset, 197.5 + yOffset, total.toLocaleString('en-US'), "center");

                    //generates QR code with total embeded in
                    for (var i = 1; i <= pagesQuantity * 2; i++) {
                        doc.setPage(i);
                        productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                        doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194 + yOffset, 15, 15);
                    }
                }

                //set pending products id (the one embeded in the qr code)
                if (withPendingProducts)
                    firebase.database().ref('pendingOrders/' + orderRefID + '/id').set(productsRefID);
                else
                    firebase.database().ref('pendingOrders/' + orderRefID).remove();

                if (event.srcElement.id == "printWithInvoiceButton")
                    uploadCompleteOrder(replaceAEIOUN($("#inputName").val().trim()), order, total, productsRefID);

                //autoprints PDF in a new tab
                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');

                //survey values
                //increaseEmployeeCounter($("#inputEmployeeName").val());
                uploadSurvey(surveyValues);

                //erase current order
                eraseOrder();
                finishOrderProducts(true);
            }
        }

        function uploadCompleteOrder(name, products, total, id) {
            firebase.database().ref("invoice/" + id).set({
                nombre: name,
                productos: products,
                subtotal: total
            });
        }

        function increaseEmployeeCounter(employee) {
            firebase.database().ref("registro/" + employee + "/pedidos").once('value', function (snapshot) {
                if (snapshot.val() == null)
                    firebase.database().ref("registro/" + employee + "/pedidos").set(1);
                else
                    firebase.database().ref("registro/" + employee + "/pedidos").set(snapshot.val() + 1);
            });
        }

        function increaseEmployeeCounterPhone(employee) {
            firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").once('value', function (snapshot) {
                if (snapshot.val() == null)
                    firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").set(1);
                else
                    firebase.database().ref("registro/" + employee + "/pedidosTelefonicos").set(snapshot.val() + 1);
            });
        }

        function roundDecimals(number) {
            return Math.round(number * 2) / 2;
        }

        //adds a new page with all the values
        function addPagePDF(doc) {
            doc.addPage();
            addTimePDF(doc);
            addNamePDF(doc);
            addMethodPDF(doc);
        }

        //adds date and time to the top right corner
        function addTimePDF(doc) {
            doc.setFontSize(13);
            doc.setFont("Gill Sans MT Condensed Negrita");

            var date = new Date();
            var months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            var fullDate = date.getDate().toString() + " / " + months[date.getMonth()] + " / " + date.getFullYear().toString();
            doc.text(19.9 + xOffset, 38.5 + yOffset, fullDate, 'center');

            var hourWithMinutes = new Date().toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            doc.text(53.5 + xOffset, 38.5 + yOffset, hourWithMinutes, 'center');
        }

        function addMethodPDF(doc) {
            doc.setFontSize(13);
            doc.setFont("Gill Sans MT Condensed Negrita");

            //special mark if the order is for the next day
            if ($("#tomorrowCheckbox").is(':checked')) {
                doc.setTextColor(255, 0, 0);
                doc.text(87 + xOffset, 38.5 + yOffset, "MANANA", 'center');
                doc.setTextColor(0, 0, 0);
            } else if (event.srcElement.id == "printByPhoneButton")
                doc.text(87 + xOffset, 38.5 + yOffset, "TELEFONO", 'center');
            else if (event.srcElement.id == "printByWhatsButton")
                doc.text(87 + xOffset, 38.5 + yOffset, "WHATSAPP", 'center');
            else
                doc.text(87 + xOffset, 38.5 + yOffset, "MOSTRADOR", 'center');

            if (event.srcElement.id == "printWithInvoiceButton") {
                doc.setFontSize(29);
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.text(130 + xOffset, 28 + yOffset, "F", "center");
            }

        }

        //adds the name
        function addNamePDF(doc) {
            var name = $("#inputName").val().trim();

            doc.setFontSize(29);
            doc.setFont("Gill Sans MT Condensed Negrita");
            doc.text(70 + xOffset, 28 + yOffset, replaceAEIOUN(name), "center");

            doc.setFontSize(12);
            doc.setFont("Gill Sans MT Condensed Negrita");
            //doc.text(43 + xOffset, 195.5 + yOffset, replaceAEIOUN($("#inputEmployeeName").val()));
        }

        //draws circle besides the description
        function drawCricle(doc, YCoordinate, validColor) {
            if (validColor == "blue")
                doc.text(5 + xOffset, YCoordinate - 1.7, "+", "center");
            else if (validColor == "red")
                doc.text(5 + xOffset, YCoordinate - 1.7, "-", "center");


            //doc.circle(5 + xOffset, YCoordinate - 1.7, .8, 'F');
        }

        //replaces special characters (current jspdf doesn´t support them)
        function replaceAEIOUN(string) {
            string = string.replace(/á/gi, "A");
            string = string.replace(/é/gi, "E");
            string = string.replace(/í/gi, "I");
            string = string.replace(/ó/gi, "O");
            string = string.replace(/ú/gi, "U");
            string = string.replace(/ñ/gi, "N");
            return string;
        }

        //generates a new QR code at the bottom left of the PDF, return a dataURL
        function generateQR(name) {
            name = name.replace("Ñ", "NN");
            document.getElementById('qrcode').innerHTML = "";
            var qrcode = new QRCode("qrcode", {
                text: name,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            var canvas = document.getElementById('qrcode').querySelector('canvas');
            return canvas.toDataURL();
        }

        //uploads or updates an order product
        function uploadOrderProduct(date, quantity, unit, description, notes, price, stock, type) {
            firebase.database().ref(globalComputer + '/order/' + date).set({
                cantidad: quantity,
                unidad: unit,
                descripcion: description,
                notas: notes,
                precio: price,
                existencia: stock,
                tipo: type
            });
        }

        function joinRepeatedProducts(surveyValues) {
            result = [];
            surveyValues.forEach(function (a) {
                if (!this[a[0]]) {
                    this[a[0]] = [a[0], 0];
                    result.push(this[a[0]]);
                }
                this[a[0]][1] += parseInt(Math.trunc(a[1] * 100), 10);
            }, Object.create(null));
            return result;
        }

        function uploadSurvey(surveyValues) {
            surveyValues = joinRepeatedProducts(surveyValues);
            for (var i = 0; i < surveyValues.length; i++) {
                let key = toAES(surveyValues[i][0]);
                let sale = surveyValues[i][1];
                firebase.database().ref('survey/' + key).once('value', function (snapshot) {
                    var aes = snapshot.key;
                    var current = snapshot.val();
                    var num = parseInt(current, 16) + sale;

                    firebase.database().ref('survey/' + aes).set(num.toString(16));
                });
            }
        }

        function toAES(string) {
            return aesjs.utils.hex.fromBytes(aesEcb.encrypt(aesjs.utils.utf8.toBytes(to16Bytes(string))));
        }

        function to16Bytes(string) {
            return string + " ".repeat(16 - string.length);
        }

        function updateName(name) {
            firebase.database().ref(globalComputer + '/name').set(name);
        }

        function updateEmployee(employee) {
            firebase.database().ref(globalComputer + '/employee').set(employee);
        }

        function updateOrderProductNotes(date, notes) {
            firebase.database().ref(globalComputer + '/order/' + date + "/notas").set(notes);
        }

        function updateOrderProductQuantity(date, quantity) {
            firebase.database().ref(globalComputer + '/order/' + date + "/cantidad").set(quantity);
        }

        function removeOrderProduct(date) {
            firebase.database().ref(globalComputer + '/order/' + date).remove();
        }

        function removeOrderProducts() {
            firebase.database().ref(globalComputer).remove();
            finishOrderProducts(false);
        }

        function finishOrderProducts(isDone) {
            firebase.database().ref(globalComputer + '/done').set(isDone);
        }

        function createNameDB(name) {
            var orderRef = firebase.database().ref('pendingOrders').push({ name: name });
            orderRefID = orderRef.key;
        }

        //uploads the aCremas product
        function aCremasOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];

            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aCremas').push(productJSON);
            firebase.database().ref('aCremas/pendientes/' + productRef.key).set(productJSON);
            return true;
        }

        //uploads the aJamones product
        function aJamonesOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];

            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aJamones').push(productJSON);
            firebase.database().ref('aJamones/pendientes/' + productRef.key).set(productJSON);
            return true;
        }

        //uploads the aBodega product
        function aBodegaOrder(productOrder, i) {
            var time = new Date();
            if ($("#tomorrowCheckbox").is(':checked'))
                productOrder[4] = "MAÑANA " + productOrder[4];

            var productJSON = {
                id: productOrder[0],
                quantity: productOrder[1],
                unit: productOrder[2],
                description: productOrder[3],
                notes: productOrder[4],
                hour: time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            var productRef = firebase.database().ref('pendingOrders/' + orderRefID + '/aBodega').push(productJSON);
            firebase.database().ref('aBodega/pendientes/' + productRef.key).set(productJSON);
            return true;
        }

        //leaves the page ready for a new order
        function eraseOrder() {
            $("#inputName").val("");
            document.getElementById("inputName").placeholder = "NOMBRE";
            $("#quantityInput").val("");
            $("#inputSearch").val("");
            $("#searchOptions").empty();
            $("#dynamic-list").html("");
            $("#dynamic-list").css("opacity", "1");
            $("#greenCheck").css("visibility", "hidden");
            document.getElementById('paymentFormSelect').value = "01";
            document.getElementById('paymentMethodSelect').value = "PUE";
            $("#totalTextFieldA").text("");
            invoiceID = "";
        }

        //checks current connection status
        function checkConnection() {
            var printButton = document.getElementById("printButton");
            var connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function (snap) {
                if (snap.val() === true) {
                    document.getElementById("noConnectionAlert").style.display = "none";
                    enableUX();
                } else {
                    document.getElementById("noConnectionAlert").style.display = "block";
                    disableUX();
                }
            });
        }

        //starts listening to connection stauts
        checkConnection();

        //removes any products from the life view
        removeOrderProducts();

        //some shortcuts. get the keycodes from here http://keycode.info
        $(document).keydown(function (e) {
            //if (e.keyCode == 221 || e.keyCode == 106)
                //generatePDF();
            if (e.keyCode == 219 || e.keyCode == 111) {
                $("#inputName").focus();
                setTimeout(function () {
                    $("#inputName").val($("#inputName").val().substring(0, $("#inputName").val().length - 1));
                }, 100);
            }
        });

    </script>
</body>