<!DOCTYPE html>
<html>

<head>
    <title>COMPRAS</title>
    <meta charset="utf-8">
    <meta name="viewport">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">

    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/index_in.css">

    <script language="javascript" type="text/javascript" src="../js/jspdf.customfonts.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/index.js"></script>
    <script language="javascript" type="text/javascript" src="../js/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/aes.js"></script>
    <script language="javascript" type="text/javascript" src="../js/defiant.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js/qrcode.js"></script>
    <script language="javascript" type="text/javascript" src="../js/firebase.js"></script>
    <script language="javascript" type="text/javascript" src="../js/facturama.api.js"></script>
    <script language="javascript" type="text/javascript" src="../js/default_vfs.js"></script>
    <script language="javascript" type="text/javascript" src="../js/bootstrap.min.js"></script>

    <script>
        var defiantProducts;
        var relationsSnapshot;
        var defiantClients,
            defiantOrders;
        var orderRefID = "";
        var globalID = "";

        firebase.initializeApp(firebaseConfig);

        var dbProducts = firebase.database().ref('products/');
        dbProducts.on('value', function (snapshot) {
            defiantProducts = Defiant.getSnapshot(snapshot.val());
        });

        firebase.database().ref('relations').on('value', function (snapshot) {
            relationsSnapshot = snapshot.val();
        });

        var clientName = "";
        var clientWhatsapp = "";

        var dbClientsValues;
        var dbClients = firebase.database().ref('clients/');
        dbClients.on('value', function (snapshot) {
            if(snapshot.val() != undefined)
                defiantClients = Defiant.getSnapshot(snapshot.val());
        });

        var dbOrders = firebase.database().ref('providers/');
        dbOrders.on('value', function (snapshot) {
            if(snapshot.val() != undefined)
                defiantOrders = Defiant.getSnapshot(snapshot.val());
        });

        var globalComputer = "IN0";
        var aesEcb = new aesjs.ModeOfOperation.ecb(aesMethod);

        var productCounter = 0;
        var qrid = "";

        var globalCode1 = 0,
            globalCode2 = 1;

    </script>

</head>

<body>
    <div class="alert alert-danger" id="noConnectionAlert" role="alert">
        <strong> No hay internet. </strong> 
            Revisa la conexión o el modem. Puedes seguir trabajando pero las cremas, jamones y otros productos no serán enviados a sus departamentos.
    </div>
    <div id="qrcode"></div>

    <div class="container-fluid">
        <div class="form-group row first-row">
            <div id="inputNameContainer" class="col-md-7">
                <input id="inputName" class="form-control" style="width: 89%;" type="input" oninput="this.value = this.value.toUpperCase()" maxlength="20" placeholder="NOMBRE"> </input>
                <ul id="clientOptions" class="list-group client-options"></ul>
                <span id="greenCheck" class="glyphicon glyphicon-ok"></span>
                <span id="greenCheckW" class="glyphicon glyphicon-ok"></span>
                <span id="greenCheckWN" class="glyphicon glyphicon-minus"></span>
                <span id="greenCheckClient" class="glyphicon glyphicon-ok"></span>
                <input id="inputNameWhatsapp" class="form-control" type="input" oninput="this.value = this.value.toUpperCase()" maxlength="10" placeholder="WHATSAPP" readonly> </input>
            </div>

            <button id="printButton" class="btn btn-primary interface-button glyphicon glyphicon-download" type="button" onclick="generatePDF('MOSTRADOR')"></button>
            <button id="printByPhoneButton" class="btn btn-danger interface-button glyphicon glyphicon-download" type="button" onclick="generatePDF('TELEFONO')"></button>
            <button id="printByPhoneButton" class="btn btn-danger interface-button glyphicon glyphicon-upload" type="button" onclick="generatePDF('WHATSAPP')"></button>
        </div>

        <div id="searchContainer" class="row">
            <div id="quantityContainer" class="col-md-1">
                <input id="quantityInput" class="form-control" type="number" min="0"></input>
            </div>
            <div id="searchNameContainer" class="col-md-11">
                <input id="inputSearch" class="form-control" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE O DESCRIPCION" type="d"></input>
                <span id="npTextField">PRODUCTOS: 0</span>
                <span id="totalTextField">$0</span>
            </div>
        </div>

        <ul id="searchOptions" class="list-group search-options"></ul>
        <ul id="dynamic-list" class="list-group"> </ul>

    </div>

    <div id="calculatorContainer">
        <div id="calculator">
            <div class="result"> <p></p> </div>
            <div class="clear btn-danger">C</div>
         
            <span class="calculator-button" style="margin-top: 22.5px; margin-left: 0;">7</span>
            <span class="calculator-button" style="margin-top: 22.5px;">8</span>
            <span class="calculator-button" style="margin-top: 22.5px;">9</span>
            <span class="calculator-button" style="margin-top: 22.5px; margin-right: 0px;">+</span>
         
            <span class="calculator-button" style="margin-left: 0px;">4</span>
            <span class="calculator-button">5</span>
            <span class="calculator-button">6</span>
            <span class="calculator-button" style="margin-right: 0px;">-</span>
         
            <span class="calculator-button" style="margin-left: 0px;">1</span>
            <span class="calculator-button">2</span>
            <span class="calculator-button">3</span>
            <span class="calculator-button" style="margin-right: 0px;">÷</span>
         
            <span class="calculator-button" style="margin-left: 0px;">0</span>
            <span class="calculator-button">.</span>
            <span class="calculator-button">=</span>
            <span class="calculator-button" style="margin-right: 0px;">x</span>
          </div>
    </div>

    <div id="addProductModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="addProductModalLabel" class="modal-title">AGREGAR PRODUCTO</h4>
                </div>
                <div class="modal-body">
                    <form id="addNewProductDBForm">
                        <div id="addNewProductDBFormWrapper" class="form-group">
                            <label id="verificationMessage"></label>
                            <div id="addProductFromTopRow" class="row">
                                <div class="col-sm-8">
                                    <label for="descriptionInput">DESCRIPCION</label>
                                    <input id="addProductDescription" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" maxlength="38" placeholder="DESCRIPCION" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="inputIDLabel">CLAVE</label>
                                    <input id="inputID" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="SATLabel">SAT</label>
                                    <input id="SATInput" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" placeholder="CODIGO" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3">
                                    <label for="priceInput">COSTO/UNIDAD</label>
                                    <input id="costInput" class="form-control" type="number" min="0" placeholder="8.50" required>
                                </div>
                                <div class="col-sm-3">
                                    <label for="weightInput">CUANTO PESA</label>
                                    <input id="costInput" class="form-control" type="number" min="0" placeholder="UNIDADES" required>
                                </div>
                                <div class="col-sm-2">
                                   <div class="form-group">
                                       <label for="unitSelect">UNIDAD</label>
                                       <select id="unitSelect" class="form-control">
                                           <option value="PIEZA" selected>PIEZA</option>
                                           <option value="KILO">KILO</option>
                                           <option value="CAJA">CAJA</option>
                                           <option value="PROMO">PROMO</option>
                                           <option value="CUB">CUB</option>
                                       </select>
                                   </div>
                               </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label for="stockSelect">EXISTENCIA</label>
                                        <select id="stockSelect" class="form-control">
                                            <option value="siHay">SÍ HAY</option>
                                            <option value="noHay">NO HAY</option>
                                            <option value="pedido">RECOMENDADO</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label for="typeSelect">TIPO</label>
                                        <select id="typeSelect" class="form-control">
                                            <option value="porPesarCamara">CAMARA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoCamara">CAMARA - YA VIENE PESADO</option>
                                            <option value="porPesarAfuera">AFUERA - SE NECESITA PESAR</option>
                                            <option value="yaPesadoAfuera">AFUERA - YA VIENE PESADO</option>
                                            <option value="yaPesadoAfueraTrino">AFUERA - YA VIENE PESADO - TRINO</option>
                                            <option value="aJamones">AREA DE JAMONES</option>
                                            <option value="aCremas">AREA DE CREMAS</option>
                                            <option value="aBodega">AREA DE BODEGA - ARRIBA</option>
                                            <option value="aBodegaAbajo">AREA DE BODEGA - ABAJO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="relationFieldsWrapper" class="row">
                                <!-- <div class="col-sm-3">
                                        <label for="datePicker">EXPIRACIÓN</label>
                                        <input id="datePicker" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" placeholder="FECHA">
                                </div> -->
                                <div class="col-sm-3">
                                    <label for="relationID">RELACIÓN</label>
                                    <input id="relationID" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE">
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label for="relationQuantity">CANTIDAD</label>
                                        <input id="relationQuantity" class="form-control" type="number" oninput="this.value = this.value.toUpperCase()" placeholder="¿CUANTOS?">
                                        <button type="button" id="addRealtionButton" class="glyphicon glyphicon-plus-sign" onclick="addRelationFields('', '');"> </button>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label id="relationLabel" for="relationQuantity">¿ES PRODUCTO PADRE?</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="cancelButton" class="btn btn-secondary" type="button" data-dismiss="modal">CANCELAR</button>
                    <button id="deleteButton" class="btn btn-danger" type="button" data-dismiss="modal" onclick="deleteProductDB();">ELIMINAR</button>
                    <button id="saveButton" class="btn btn-danger" type="button" data-type="newProduct" onclick="verifyNewProduct();">GUARDAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        //when order is created adds one to local and database codes
        updateGlobalCodes();

        //inputName on enter sequence
        $("#inputName").on('keyup', function (e) {
            if (e.keyCode == 13) {
                if(!isNumeric($("#inputName").val().slice(-1)) && isNumeric($("#inputName").val().charAt($("#inputName").val().length - 2)))
                    searchOrderById($("#inputName").val());
                else {
                    $("#quantityInput").focus();
                } 
            } 
        });

        function isNumeric(str) {
            return /^\d+$/.test(str);
        }
        
        //addClient modal enter sequence
        $("#formNameInput").on('keyup', function (e) {
            if (e.keyCode == 13) $("#formNumberInput").focus();
        });

        $(document).on('click', function(e) {
            if (e.target.id != 'inputName' && e.target.id != 'clientOptions')
                $("#clientOptions").empty();
        });

        $(document).on('keyup', function (e) {
            if (e.keyCode == 187) 
                prepareToScan();
        });

        //inputQuantity enter sequence
        $("#quantityInput").on('keyup', function (e) {
            if (e.keyCode == 13)
                $("#inputSearch").focus();
        });

        //remove edited product when modal is untoggled
        $("#addProductModal").on("hidden.bs.modal", function () {
            if ($('#saveButton').data("type") == "editProduct") {
                $('#dynamic-list li:first-child').remove();
            }
        });
        
        //clients live search action
        $("#inputName").on('keyup', function (e) {
            clientName = "";
            clientWhatsapp = "";
            $("#greenCheck").css("visibility", "hidden");
            $("#greenCheckW").css("visibility", "hidden");
            $("#greenCheckWN").css("visibility", "hidden");

            firebase.database().ref("liveviews/" + globalComputer + '/sorder').remove();

            var searchResult;
            var inputSearchValue = $('#inputName').val();
            //search two or more words... impossible id
            if (inputSearchValue.includes(" ")) {
                inputSearchValue = inputSearchValue.split(" ");
                for (i = 0; i < inputSearchValue.length; i++) {
                    if (inputSearchValue[i] != "") {
                        if (searchResult == null) {
                            //searchResult = JSON.search(defiantClients, '//*[contains(nombre, "' + inputSearchValue[i] + '")]' + '|//*[contains(numero, "' + inputSearchValue[i] + '")]');
                            searchResult = JSON.search(defiantOrders, '//*[contains(name, "' + inputSearchValue[i] + '")]');
                        }
                        else {
                            //searchResult = JSON.search(searchResult, '//*[contains(nombre, "' + inputSearchValue[i] + '")]' + '|//*[contains(numero, "' + inputSearchValue[i] + '")]');
                            searchResult = JSON.search(searchResult, '//*[contains(name, "' + inputSearchValue[i] + '")]');
                        } 
                    }
                }
            }
            //search one word... posible id
            else {
                if ($('#inputName').val() != "") {
                    searchResult = JSON.search(defiantOrders, '//*[contains(name, "' + inputSearchValue + '")]');
                }
            }

            //loads the results into the list
            $("#clientOptions").empty();
            if ($('#inputName').val() != "") {
                //$("#dynamic-list").css("opacity", "0.25");
                //populateLiveClientList(searchResult);
                populateLiveOrderList(searchResult);

                //on enter the first search item is selected
                if (e.keyCode == 13 && searchResult.length > 0) {
                    //addClientObjectGetter(searchResult[0].Id);
                    addOrderObjectGetter(searchResult[0].Id);

                }
            }// else
                //$("#dynamic-list").css("opacity", "1");
        });

        //products live search
        $("#inputSearch").on('keyup', function (e) {
            //POSIBLE if searching then blur background
            if (e.keyCode == 219 || e.keyCode == 111) {
                $("#dynamic-list").css("opacity", "1");
                $("#inputName").focus();
                $("#inputSearch").val($("#inputSearch").val().substring(0, $("#inputSearch").val().length - 1));
                setTimeout(function () {
                    $("#inputName").val($("#inputName").val().substring(0, $("#inputName").val().length - 1));
                }, 100);
            //POSIBLE unblur background
            } else if (e.keyCode == 221 || e.keyCode == 106) {
                $("#dynamic-list").css("opacity", "1");
                verifyOrder("");
            }

            //search action
            else {
                var searchResult;
                var inputSearchValue = $('#inputSearch').val();
                //search two or more words... imposible id
                if (inputSearchValue.includes(" ")) {
                    inputSearchValue = inputSearchValue.split(" ");
                    for (i = 0; i < inputSearchValue.length; i++) {
                        if (inputSearchValue[i] != "") {
                            if (searchResult == null)
                                searchResult = JSON.search(defiantProducts, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                            else
                                searchResult = JSON.search(searchResult, '//*[contains(descripcion, "' + inputSearchValue[i] + '")]' +
                                    '|//*[contains(unidad, "' + inputSearchValue[i] + '")]');
                        }
                    }
                }
                //search just one word... posible id
                else {
                    if ($('#inputSearch').val() != "") {
                        searchResult = JSON.search(defiantProducts, '//*[contains(clave, "' + $('#inputSearch').val() + '")]');
                        searchResultSecond = JSON.search(defiantProducts, '//*[contains(descripcion, "' + $('#inputSearch').val() + '")]' +
                            '|//*[contains(unidad, "' + $('#inputSearch').val() + '")]');
                        Array.prototype.push.apply(searchResult, searchResultSecond);
                    }
                }

                //loads the results into the list
                $("#searchOptions").empty();
                if ($('#inputSearch').val() != "") {
                    $("#dynamic-list").css("opacity", "0.25");
                    populateLiveSearchList(searchResult);

                    //on enter the first search item is selected
                    if (e.keyCode == 13 && searchResult.length > 0)
                        addProduct(searchResult[0]);
                } else {
                    $("#dynamic-list").css("opacity", "1");
                }
            }
        });

        //calculator
        window.onload = function () {
            var buttons = document.getElementsByClassName('calculator-button'),
                result = document.querySelectorAll('.result p')[0],
                clear = document.getElementsByClassName('clear')[0];
            
            for (var i = 0; i < buttons.length; i++) {
                if (buttons[i].innerHTML === '=') buttons[i].addEventListener("click", calculate(i));
                else buttons[i].addEventListener("click", addValue(i));
            }
            
            clear.onclick = function () {
                result.innerHTML = '';
            };  
            
            function addValue(i) {
                return function () {
                    if(i == 15)
                        result.innerHTML += "*";
                    else if(i == 11)
                        result.innerHTML += "/";
                    else
                        result.innerHTML += buttons[i].innerHTML;
                };
            }
            
            function calculate(i) {
                return function () {
                    var final_res = result.innerHTML;                                 
                    result.innerHTML = eval(final_res);
                };
            }
        };

        function prepareToScan() {
            $('#inputName').val("");
            $('#inputName').focus();
        }

        function updateGlobalCodes() {
            firebase.database().ref('extras/code1').on('value', function (snapshot) {
                if(snapshot.val() != undefined) {
                    globalCode1 = snapshot.val();
                }
            });
            firebase.database().ref('extras/code2').on('value', function (snapshot) {
                if(snapshot.val() != undefined) {
                    globalCode2 = snapshot.val();
                }
            });
        }

        function addRelationFields(key, value) {
            var fields = '<div class="row new-relation">' +
                            '<div class="col-sm-3">' +
                                '<input id="relationID" class="form-control" type="text" oninput="this.value = this.value.toUpperCase()" placeholder="CLAVE" value="' + key + '">' +
                            '</div>' +
                            '<div class="col-sm-3">' +
                                '<div class="form-group">' +
                                    '<input id="relationQuantity" class="form-control" type="number" oninput="this.value = this.value.toUpperCase()" placeholder="¿CUANTOS?" value="' + value + '">' +
                                '</div>' +
                            '</div>'
                        '</div>';

            $("#addNewProductDBFormWrapper").append(fields);
        }

        function searchOrderById(id) {
            id = id.replaceAll(".", "").replaceAll(" ", "");
            firebase.database().ref("providers/" + id).once('value', function (snapshot) {
                if(snapshot.val() != null) {
                    populateOrder(snapshot.val());
                } else {
                    console.log("no encontré nada");
                    //emptyForm(document.getElementById("searchOrderForm"), 3);
                    //document.getElementById("verificationMessageId").innerHTML = "NO SE GUARDÓ NINGUNA NOTA CON ESE CODIGO.";
                }
            });
        }

        function deleteOrder() {
            if(globalID != "") {
                firebase.database().ref("providers/" + globalID).remove();
            }
            eraseOrder();
        }
        
        function populateOrder(order) {
            eraseOrder();

            $("#quantityInput").val("");
            $("#inputSearch").val("");
            $("#searchOptions").empty();
            
            $("#inputName").val(order.name);
            globalID = order.qr;

            $("#inputNameWhatsapp").val(order.whatsapp);

            $("#saveOrderButton").css("visibility", "visible");

            if(order.calculable) {
                $("#greenCheckClient").css("visibility", "visible");
            } else {
                $("#greenCheckClient").css("visibility", "hidden");
            }

            (function iterateOverProductsWithDelay (i) {          
                setTimeout(function () {   
                    addProductFromSavedOrder(Object.keys(order.products)[i - 1], Object.values(order.products)[i - 1]);
                    if (--i) {
                        iterateOverProductsWithDelay(i);
                    } else {
                        $("#quantityInput").focus();
                    }
                }, 1)
            })(Object.keys(order.products).length);
        }

        //adds the item to the list
        function addProduct(product) {
            $("#searchOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#inputSearch").val("");

            var date = (new Date()).getTime();
            var color,
                backgroundColor;

            if(product.existencia == "siHay") {
                color = "#EEEEEE";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "noHay") {
                color = "rgba(216, 61, 52, 95%)";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "pedido") {
                color = "rgba(51, 204, 51, 80%)";
                backgroundColor = "#111111";
            }

            var totalCost = "";
            if($("#quantityInput").val() != "") {
                totalCost = $("#quantityInput").val() * product.costo;
                totalCost = "$" + Math.round(totalCost * 10) / 10;
            }
                
            var productListItem =
                '<li class="list-group-item row product-row product-total" style= "background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555;" data-id="' + product.clave + '" data-date="' + date + '" data-total="' + round($("#quantityInput").val() * product.costo) + '">' +
                    '<div class="col-sm-1 product-quantity">' +
                        '<input class="form-control" type="number" min="0" style= "color: ' + color + '; background-color: ' + backgroundColor + '; border-color: #555555; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;"></input>' +
                    '</div>' +
                    '<div class="col-sm-1 product-info">' + product.unidad + '</div>' +
                    '<div class="col-sm-5 product-info">' + product.descripcion + '</div>' +
                    '<div id="localCost" class="col-sm-1 product-info">' + totalCost + '</div>' +
                    '<div class="col-sm-1 product-notes-container">' +
                        '<input class="form-control product-price" type="input" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;" oninput="this.value = this.value.toUpperCase()" maxlength="48" placeholder="PRECIO" value="' + product.costo + '"> </input>' +
                    '</div>' +
                    '<div class="col-sm-2 product-notes-container">' +
                        '<input class="form-control product-notes" type="input" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;" oninput="this.value = this.value.toUpperCase()" maxlength="48" placeholder="NOTAS"> </input>' +
                    '</div>' +
                    '<button class="btn btn-default btn-sm col-sm-1 remove-button cross" type="button" style="background-color: ' + backgroundColor + '; border-color: ' + backgroundColor + ';">' +
                        '<span class="glyphicon glyphicon-remove cross" style="color:grey; padding-top: 4.5px;"></span>' +
                    '</button>' +
                '</li>';

            //add list element
            $('#dynamic-list').prepend(productListItem);
            updateTotal();
            
            //populate quantity and clean original (outter) input
            var outterQuantity = $("#quantityInput").val();
            var inputQuantity = $('#dynamic-list').find('input').first();
            inputQuantity.val(outterQuantity);
            $("#quantityInput").val("");
            
            productCounter++;
            updateNP(productCounter);

            //inputSearch sequence
            $('#dynamic-list').find('input').eq(1).focus();

            $('#dynamic-list').find('input').first().on('change', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(4).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(4).children().val()));
                updateTotal();
            })

            //inputQuantity enter sequence (to notes)
            $('#dynamic-list').find('input').first().on('keyup', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(4).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(4).children().val()));
                updateTotal();
                if (e.keyCode == 13)
                    $(this).parent().nextAll().eq(3).children().focus();
            });

            //price enter
            $('#dynamic-list').find('input').eq(1).on('keyup', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(0).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(0).children().val()));
                updateTotal();
                if (e.keyCode == 13)
                    $("#quantityInput").focus();
            })

            //inputNotes enter sequence with shortcuts (to outter quantity)
            var inputNotes = $('#dynamic-list').find('input').eq(2);
            inputNotes.on('keyup', function (e) {
                if (e.keyCode == 13) {
                    if (inputNotes.val() == "S")
                        inputNotes.val("SURTIDO");
                    else if (inputNotes.val() == "K")
                        inputNotes.val("EN KILOS");
                    else if (inputNotes.val() == "M")
                        inputNotes.val("EN MEDIOS");
                    else if (inputNotes.val() == "C")
                        inputNotes.val("EN CUARTOS");
                    else if (inputNotes.val() == "2")
                        inputNotes.val("2-2");
                    else if (inputNotes.val() == "3")
                        inputNotes.val("3-3");
                    else if (inputNotes.val() == "4")
                        inputNotes.val("4-4");
                    else if (inputNotes.val() == "5")
                        inputNotes.val("5-5");
                    else if (inputNotes.val() == "J")
                        inputNotes.val("JUNTA");
                    $("#quantityInput").focus();
                }
            });

            $('#dynamic-list').children().first().on("mouseup", "button", function (e) {
                e.preventDefault();
                
                $(this).parent().remove();
                
                updateTotal();
                productCounter--;
                updateNP(productCounter);
            });
        }

        function addProductFromSavedOrder(id, product) {
            id = id.substring(3);

            var notesAndQuantity = product;
            product = JSON.search(defiantProducts, '//*[clave="' + id + '"]')[0];

            $("#searchOptions").empty();
            $("#dynamic-list").css("opacity", "1");
            $("#inputSearch").val("");

            var date = (new Date()).getTime();
            var color,
                backgroundColor;

            if(product.existencia == "siHay") {
                color = "#EEEEEE";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "noHay") {
                color = "rgba(216, 61, 52, 95%)";
                backgroundColor = "#111111";
            }
            else if(product.existencia == "pedido") {
                color = "rgba(51, 204, 51, 80%)";
                backgroundColor = "#111111";
            }

            var totalCost = notesAndQuantity.uc * notesAndQuantity.p;
            totalCost = "$" + Math.round(totalCost * 10) / 10
               
            var productListItem =
                '<li class="list-group-item row product-row product-total" style= "background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555;" data-id="' + product.clave + '" data-date="' + date + '" data-total="' + round(notesAndQuantity.uc * notesAndQuantity.p) + '">' +
                    '<div class="col-sm-1 product-quantity">' +
                        '<input class="form-control" type="number" min="0" style= "color: ' + color + '; background-color: ' + backgroundColor + '; border-color: #555555; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;"></input>' +
                    '</div>' +
                    '<div class="col-sm-1 product-info">' + product.unidad + '</div>' +
                    '<div class="col-sm-5 product-info">' + product.descripcion + '</div>' +
                    '<div id="localCost" class="col-sm-1 product-info">' + totalCost + '</div>' +
                    '<div class="col-sm-1 product-notes-container">' +
                        '<input class="form-control product-price" type="input" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;" oninput="this.value = this.value.toUpperCase()" maxlength="48" placeholder="PRECIO" value="' + notesAndQuantity.p + '" readonly> </input>' +
                    '</div>' +
                    '<div class="col-sm-2 product-notes-container">' +
                        '<input class="form-control product-notes" type="input" style= "color: ' + color + '; background-color: ' + backgroundColor + '; height: 30px; margin-top: 2.5px; padding-top: 1px; padding-bottom: 0px; line-height: 4px;" oninput="this.value = this.value.toUpperCase()" maxlength="48" placeholder="NOTAS" value="' + notesAndQuantity.n + '"> </input>' +
                    '</div>' +
                    '<button class="btn btn-default btn-sm col-sm-1 remove-button cross" type="button" style="background-color: ' + backgroundColor + '; border-color: ' + backgroundColor + ';">' +
                        '<span class="glyphicon glyphicon-remove cross" style="color:grey; padding-top: 4.5px;"></span>' +
                    '</button>' +
                '</li>';

            //add list element
            $('#dynamic-list').prepend(productListItem);
            updateTotal();

            var inputQuantity = $('#dynamic-list').find('input').first();
            inputQuantity.val(notesAndQuantity.uc);
            
            //populate quantity and clean original (outter) input
            productCounter++;
            updateNP(productCounter);

            //inputSearch sequence
            $('#dynamic-list').find('input').eq(1).focus();

            $('#dynamic-list').find('input').first().on('change', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(4).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(4).children().val()));
                updateTotal();
            })

            //inputQuantity enter sequence (to notes)
            $('#dynamic-list').find('input').first().on('keyup', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(4).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(4).children().val()));
                updateTotal();
                if (e.keyCode == 13)
                    $(this).parent().nextAll().eq(3).children().focus();
            });

            //price enter
            $('#dynamic-list').find('input').eq(1).on('keyup', function (e) {
                let thisRow = $("#dynamic-list").find("[data-date='" + $(this).parent().parent().data("date") + "']");
                thisRow.data("total", (round($(this).val() * thisRow.children().eq(0).children().val())));
                thisRow.children().eq(3).text("$" + round($(this).val() * thisRow.children().eq(0).children().val()));
                updateTotal();
                if (e.keyCode == 13)
                    $("#quantityInput").focus();
            })

            //inputNotes enter sequence with shortcuts (to outter quantity)
            var inputNotes = $('#dynamic-list').find('input').eq(2);
            inputNotes.on('keyup', function (e) {
                if (e.keyCode == 13) {
                    if (inputNotes.val() == "S")
                        inputNotes.val("SURTIDO");
                    else if (inputNotes.val() == "K")
                        inputNotes.val("EN KILOS");
                    else if (inputNotes.val() == "M")
                        inputNotes.val("EN MEDIOS");
                    else if (inputNotes.val() == "C")
                        inputNotes.val("EN CUARTOS");
                    else if (inputNotes.val() == "2")
                        inputNotes.val("2-2");
                    else if (inputNotes.val() == "3")
                        inputNotes.val("3-3");
                    else if (inputNotes.val() == "4")
                        inputNotes.val("4-4");
                    else if (inputNotes.val() == "5")
                        inputNotes.val("5-5");
                    else if (inputNotes.val() == "J")
                        inputNotes.val("JUNTA");
                    $("#quantityInput").focus();
                }
            });

            $('#dynamic-list').children().first().on("mouseup", "button", function (e) {
                e.preventDefault();
                
                $(this).parent().remove();
                
                updateTotal();
                productCounter--;
                updateNP(productCounter);
            });
        }

        //generates random int with max value
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        //populates client search list after the result has been processed
        function populateLiveOrderList(searchResult) {
            var clientItem = "";
            //up to 51 results in search bar
            var orderDate;
            var orderHours,
                orderMinutes;
            var calculableCheckMark;
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                calculableCheckMark = "";    
                if(searchResult[i].calculable)
                    calculableCheckMark = "glyphicon-ok";

                clientItem = '<button class="list-group-item list-width client-options-item row btn-default" onclick="searchOrderById(&#39;' + searchResult[i].qr + '&#39;)">' +
                    '<div id="clientNameResult" class="col-sm-7">' + searchResult[i].name + '</div>' + 
                    '<div class="col-sm-3 no-horizontal-padding">' + searchResult[i].whatsapp + '</div>' + 
                    '<div class="col-sm-1 no-horizontal-padding">$' + searchResult[i].subtotal + '</div>';
                    //'<span id="greenCheckClientLive" class="glyphicon ' + calculableCheckMark + '"></span>';
                
                $("#clientOptions").append(clientItem);
            }
        }

        //populates live search of products list after the result has been processed
        function populateLiveSearchList(searchResult) {
            var backgroundColor,
                color,
                buttonColor;
            var searchItem = "";

            //up to 51 results in search bar
            for (var i = 0; i < searchResult.length && i < 51; i++) {
                if(searchResult[i].existencia == "siHay") {
                    backgroundColor = "#111111";
                    color = "#EEEEEE";
                    buttonColor = "gray";
                } else if(searchResult[i].existencia == "noHay") {
                    buttonColor = "#rgba(216, 61, 52, 95%)";
                    color = "rgba(216, 61, 52, 95%)";
                    backgroundColor = "#111111";
                } else if(searchResult[i].existencia == "pedido") {
                    buttonColor = "rgba(51, 204, 51, 80%)";
                    color = "rgba(51, 204, 51, 80%)";
                    backgroundColor = "#111111";
                }

                searchItem =
                    '<button class="list-group-item row btn-default search-options-item" onclick="addProductObjectGetter(&#39;' + searchResult[i].clave + '&#39;)" style="background-color: ' + backgroundColor + '; color: ' + color + '; border-color: #555555;">' +
                        '<div class="col-sm-2">' + searchResult[i].clave + '</div>' +
                        '<div class="col-sm-1">' + searchResult[i].unidad + '</div>' +
                        '<div class="col-sm-7">' + searchResult[i].descripcion + '</div>' +
                        '<div class="col-sm-1">' + searchResult[i].costo + '</div>' +
                        '<div class="btn btn-sm col-sm-1 edit-button" type="button" onclick="editProductModal(&#39;' + searchResult[i].clave + '&#39;)">' +
                        '<span id="editButton" style="color:' + buttonColor + ';"> EDITAR </span>' +
                        '</div>' +
                    '</button>';

                $("#searchOptions").append(searchItem);
            }
        }

        //edit or delete product modal values
        function editProductModal(id) {
            document.getElementById("addProductModalLabel").innerHTML = "EDITAR PRODUCTO";
            document.getElementById("inputID").disabled = true;
            document.getElementById("deleteButton").style.display = "inline";
            document.getElementById("verificationMessage").innerHTML = "";

            var productToEdit = JSON.search(defiantProducts, '//*[clave="' + id + '"]')[0];
            var form = document.getElementById("addNewProductDBForm");

            //{description:0, id:1, SAT:2, cost:3, unit:4, stock:5, type:6}
            form.elements[0].value = productToEdit.descripcion;
            form.elements[1].value = productToEdit.clave;
            form.elements[2].value = productToEdit.xpcode;
            form.elements[3].value = productToEdit.costo;

            if(productToEdit.pesoN != undefined && productToEdit.pesoN != "")
                form.elements[3].value = (productToEdit.costo / productToEdit.pesoN).toString();
            form.elements[4].value = productToEdit.pesoN;

            $("#unitSelect").val(productToEdit.unidad);
            $("#stockSelect").val(productToEdit.existencia);
            $("#typeSelect").val(productToEdit.tipo);
            $(".new-relation").remove();

            if(relationsSnapshot[id] != undefined) {
                //product has one relation
                if(Object.keys(relationsSnapshot[id]).length >= 1) {
                    $("#relationID").val(Object.keys(relationsSnapshot[id])[0]);
                    $("#relationQuantity").val(Object.values(relationsSnapshot[id])[0]);
                    
                    //relation is child type
                    if(Object.values(relationsSnapshot[id])[0] <= 1)
                    disableRelationInput();
                }
                
                //relationn is parent type
                if(Object.keys(relationsSnapshot[id]).length > 1) {
                    enableRelationInput();
                    for (const [key, value] of Object.entries(relationsSnapshot[id])) {
                        if(Object.keys(relationsSnapshot[id])[0] != key) {
                            addRelationFields(key, value);
                        }     
                    }
                } 
            }

            //sets buttons inner values
            $('#saveButton').data("type", "editProduct");
            $('#saveButton').data("id", form.elements[1].value);

            $('#addProductModal').modal('show');
        }

        function disableRelationInput() {
            $("#relationID").prop('disabled', true); 
            $("#relationQuantity").prop('disabled', true); 
            $("#addRealtionButton").css('display', 'none'); 
            $("#relationLabel").css('display', 'none'); 
        }

        function enableRelationInput() {
            $("#relationID").prop('disabled', false); 
            $("#relationQuantity").prop('disabled', false); 
            $("#addRealtionButton").css('display', 'inline-block'); 
            $("#relationLabel").css('display', 'block'); 
        }

        //sets modal to add product view
        function addProductModal() {
            document.getElementById("addProductModalLabel").innerHTML = "AGREGAR PRODUCTO";
            document.getElementById("inputID").disabled = false;
            document.getElementById("deleteButton").style.display = "none";
            document.getElementById("verificationMessage").innerHTML = "";
            emptyForm(document.getElementById("addNewProductDBForm"), 7);

            if($("#relationFieldsWrapper").siblings()[3] != undefined)
                $("#relationFieldsWrapper").siblings()[3].remove();
            if($("#relationFieldsWrapper").siblings()[4] != undefined)
                $("#relationFieldsWrapper").siblings()[4].remove();
            if($("#relationFieldsWrapper").siblings()[5] != undefined)
                $("#relationFieldsWrapper").siblings()[5].remove();

            $(".new-relation").remove();
            enableRelationInput();

            $('#saveButton').data("type", "newProduct");
            $('#addProductModal').modal('show');
        }

        //deletes an existing product from the db
        function deleteProductDB() {
            $('#dynamic-list li:first-child').remove();
            var id = document.getElementById("addNewProductDBForm").elements[1].value;
            dbProducts.child(id).remove();

            firebase.database().ref('inventory/' + id).remove();
            firebase.database().ref('relations/' + id).remove();
            
            //remove embeded relations
            firebase.database().ref("relations").once('value', function(snapshot) {
                if(snapshot.val() != undefined) {
                    for (let bigId in snapshot.val()) {
                        for (let smallId in snapshot.val()[bigId]) {
                            if(smallId == id) {
                                firebase.database().ref("relations/" + bigId + "/" + smallId).remove();
                            }
                        }
                    }
                }
            });
        }

        //verifies input of modal form
        function verifyNewProduct() {
            var messageLabel = document.getElementById("verificationMessage");
            var form = document.getElementById("addNewProductDBForm");
            var verified = true;

            //checks for blanks
            var inputs = new Array(11);
            
            for (var i = 0; i < 11; i++)
                inputs[i] = form.elements[i].value;

            if (inputs[0] == "") {
                messageLabel.innerHTML = "FALTA DESCRIPCION.";
                verified = false;
            } else if (inputs[1] == "") {
                messageLabel.innerHTML = "FALTA CLAVE.";
                verified = false;
            } else if (inputs[2] == "") {
                messageLabel.innerHTML = "FALTA CODIGO DE SAT.";
                verified = false;
            } else if (inputs[3] == "") {
                messageLabel.innerHTML = "FALTA COSTO.";
                verified = false;
            } else if (inputs[5] == "") {
                messageLabel.innerHTML = "FALTA UNIDAD.";
                verified = false;
            } else if (inputs[6] == "") {
                messageLabel.innerHTML = "FALTA EXISTENCIA.";
                verified = false;
            } else if (inputs[7] == "") {
                messageLabel.innerHTML = "FALTA TIPO.";
                verified = false;
            }

            //checks for spaces in id
            if (form.elements[1].value.indexOf(" ") >= 0) {
                messageLabel.innerHTML = "LA CLAVE NO PUEDE TENER ESPACIOS.";
                verified = false;
            }

            //checks for 8 digit format in SAT
            if (isNaN(form.elements[2].value) || form.elements[2].value.length != 8) {
                messageLabel.innerHTML = "EL CODIGO DEL SAT DEBE DE SER DE 8 DIGITOS.";
                verified = false;
            }
            
            //checks for $ or -
            if (form.elements[1].value.indexOf("$") >= 0 || form.elements[1].value.indexOf("-") >= 0) {
                messageLabel.innerHTML = "LA CLAVE SOLO PUEDE TENER LETRAS Y/O NUMEROS";
                verified = false;
            }

            //checks for existing ids
            if (form.elements[1].value != "") {
                dbProducts.child(form.elements[1].value).once('value', function (snapshot) {
                    //when in add product view, the id needs to be always a new one
                    if ($('#saveButton').data("type") == "newProduct") {
                        if (snapshot.val() !== null) {
                            messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                            verified = false;
                        }
                    }
                    //when in edit product, the id can be either the same or a new one, but not an existing one
                    else if ($('#saveButton').data("type") == "editProduct") {
                        if ($('#saveButton').data("id") != form.elements[1].value) {
                            if (snapshot.val() !== null) {
                                messageLabel.innerHTML = "LA CLAVE YA EXISTE, INTENTA UNA DIFERENTE.";
                                verified = false;
                            }
                        }
                    }
                });
            }

            //checks for stock status
            if ($('#unitSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR UNIDAD.";
                verified = false;
            }

            //checks for stock status
            if ($('#stockSelect').val() == "undefined") {
                messageLabel.innerHTML = "FALTA DEFINIR EXISTENCIA.";
                verified = false;
            }

            //if everything is checked, upload form
            if (verified) {
                uploadRelations(form.elements);

                addNewProductDB(inputs);
                messageLabel.innerHTML = "";


                //if at edit product the id changes, deletes the old ids instance
                if ($('#saveButton').data("type") == "editProduct")
                    if ($('#saveButton').data("id") != form.elements[1].value)
                        dbProducts.child($('#saveButton').data("id")).remove();

                emptyForm(form, inputs.length);
            }
        }

        function uploadRelations(elements) {
            if (elements[8].value != undefined && elements[8].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[8].value).set(elements[9].value);
                firebase.database().ref("relations/" + elements[8].value + "/" + elements[1].value).set(1 / elements[9].value);
            } if (elements[11] != undefined && elements[11].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[10].value).set(elements[11].value);
                firebase.database().ref("relations/" + elements[10].value + "/" + elements[1].value).set(1 / elements[11].value);
            } if (elements[13] != undefined && elements[13].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[13].value).set(elements[13].value);
                firebase.database().ref("relations/" + elements[13].value + "/" + elements[1].value).set(1 / elements[14].value);
            } if (elements[15] != undefined && elements[15].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[15].value).set(elements[16].value);
                firebase.database().ref("relations/" + elements[15].value + "/" + elements[1].value).set(1 / elements[16].value);
            } if (elements[17] != undefined && elements[17].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[17].value).set(elements[18].value);
                firebase.database().ref("relations/" + elements[17].value + "/" + elements[1].value).set(1 / elements[18].value);
            } if (elements[19] != undefined && elements[19].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[19].value).set(elements[20].value);
                firebase.database().ref("relations/" + elements[19].value + "/" + elements[1].value).set(1 / elements[20].value);
            } if (elements[21] != undefined && elements[21].value != "") {
                firebase.database().ref("relations/" + elements[1].value + "/" + elements[21].value).set(elements[22].value);
                firebase.database().ref("relations/" + elements[21].value + "/" + elements[1].value).set(1 / elements[22].value);
            }
        }

        //clears modal form values
        function emptyForm(form, length) {
            form.reset();
        }

        //adds or updates a product to firebase
        function addNewProductDB(inputs) {
            var costoLocal = inputs[3];
            if(inputs[4] != undefined && inputs[4] != "")
                costoLocal = (inputs[3] * inputs[4]).toString();

            firebase.database().ref('products/' + inputs[1]).set({
                clave: inputs[1],
                costo: costoLocal,
                descripcion: inputs[0],
                existencia: inputs[6],
                pesoN: inputs[4],
                tipo: inputs[7],
                unidad: inputs[5],
                xpcode: inputs[2],
                categoria: 1
            }).then(function () {
                $('#addProductModal').modal('toggle');
            });

            firebase.database().ref('inventory/' + inputs[1] + "/stock").set(0);
        }

        //FIX adds a product to the order by id (only gets the product from the DB so that it can be added in addProduct())
        function addProductObjectGetter(ID) {
            var searchResult = JSON.search(defiantProducts, '//*[clave="' + ID + '"]');
            addProduct(searchResult[0]);
        }

        //populates an array with all the order product values
        function getOrderProducts() {
            var verifiedOrder = true;
            var typesSequence = ["porPesarCamara", "yaPesadoCamara", "porPesarAfuera", "yaPesadoAfuera", "yaPesadoAfueraTrino", "aCremas", "aJamones", "aBodega", "aBodegaAbajo"];
            
            var newOrder = [];

            //iterates over order types to divide them
            for (var sequenceIndex = 0; sequenceIndex < typesSequence.length; sequenceIndex++) {
                var orderTypeSection = [];
                //iterates over order list items
                $("#dynamic-list").children().each(function (index) {
                    if (JSON.search(defiantProducts, '//*[clave="' + $(this).data("id") + '"]')[0].tipo == typesSequence[sequenceIndex]) {
                        var productItem = $(this).children();

                        var orderTypeUnit = [];
                        orderTypeUnit.push($(this).data("id"));
                        orderTypeUnit.push(productItem.eq(0).children().val());
                        orderTypeUnit.push(productItem.eq(1).text());
                        orderTypeUnit.push(productItem.eq(2).text());
                        orderTypeUnit.push(productItem.eq(4).children().val());
                        orderTypeUnit.push(productItem.eq(5).children().val());
                        orderTypeUnit.push(JSON.search(defiantProducts, '//*[clave="' + $(this).data("id") + '"]')[0].tipo);
                        orderTypeUnit.push(JSON.search(defiantProducts, '//*[clave="' + $(this).data("id") + '"]')[0].xpcode);
                        orderTypeUnit.push(JSON.search(defiantProducts, '//*[clave="' + $(this).data("id") + '"]')[0].costo);

                        orderTypeSection.push(orderTypeUnit);

                        //orderTypeUnit.push(JSON.search(defiantProducts, '//*[clave="' + $(this).data("id") + '"]')[0].categoria);

                        //verificating quantity
                        if (orderTypeUnit[1] == "" || orderTypeUnit[1] == "0") {
                            alert("Un producto no tiene cantidad, ingresa todas las cantidades.");
                            verifiedOrder = false;
                        }
                    }
                });
                
                orderTypeSection.sort(compareOrders);
                if(orderTypeSection.length > 0)
                    for(var i in orderTypeSection)
                        newOrder.push(orderTypeSection[i]);
            }

            return newOrder;
        }

        function compareOrders(a, b) {
            if (a[3] < b[3])
                return -1;
            if (a[3] > b[3])
                return 1;
            return 0;
        }

        function updateTotal() {
            var total = 0;
            $(".product-total").each(function(index) {
                total = total + ($(this).data("total") * 1);
            });

            $("#totalTextField").text("$" + round(total));
        }

        //updates the total numbero of different products
        function updateNP(np) {
            $("#npTextField").text("PRODUCTOS: " + np);
        }

        function verifyOrder(orderMethod) {
            var verifiedOrder = true;
            if ($("#inputName").val() == "") {
                alert("FALTA EL NOMBRE DEL CLIENTE");
                verifiedOrder = false;
            } else if (!$("#inputName").val().match(/[A-Z]/i)) {
                alert("El NOMBRE DEL CLIENTE NO PUEDE SER UN NUMERO");
                verifiedOrder = false;
            }

            if (verifiedOrder) {   
                generatePDF(orderMethod);
            }
        } 


        var xOffset = 40;
        var yOffset = -2;
        //FIX huge function - generates a PDF with autoprint
        function generatePDF(orderMethod) {
            
            //set PDF defaults
            var order = getOrderProducts();
            console.log("order");
            console.log(order);
            var doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: [297, 210]
            });

            //add custom fonts
            doc.addFont('GILC____.TTF', "Gill Sans Std Condensed", "normal");
            doc.addFont('GillSansMTCondensedBold.ttf', "Gill Sans MT Condensed Negrita", "normal");

            var ordertype = orderMethod;
            
            //add defaults values
            addTimePDF(doc);
            addMethodPDF(doc, orderMethod);
            var cleanName = addNamePDF(doc, order.length);

            //creates pending products key (aJamones, aCremas, aBodega)
            var productsRefID = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            var randomLetter1 = possible.charAt(Math.floor(Math.random() * possible.length));
            var randomLetter2 = possible.charAt(Math.floor(Math.random() * possible.length));

            doc.setPage(1);

            var shortenedUnits = {
                KILO: "KG",
                PIEZA: "PZ",
                CAJA: "CJ",
                CUB: "CB",
                EXB: "EX",
                PROMO: "PR"
            };

            var sOrderProducts = {};

            var calculable = true;
            var total = 0;

            var firstLineYPosition = 49.8 + yOffset;
            var lineHeight = 8.54;
            var currentLine = 0;
            var pagesQuantity = 1;
            var surveyValues = order;
            var nproducts = 0;
            var ndiversity = 0;
            var haspanela = false;
            var hasChuletaN = false;
            var onlyafuera = true;
            var hasBidon = false;

            for (var i = 0; i < order.length; i++) {
                //adds new page if necessary
                if (currentLine == 17) {
                    pagesQuantity++;
                    addPagePDF(doc, orderMethod, order.length);
                    //addPagePDF(doc, orderMethod, order.length);
                    doc.setPage(pagesQuantity);
                    currentLine = 0;
                }

                //quantity and unit
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.setFontSize(12.5);
                var quantityAndUnit = order[i][1] + shortenedUnits[order[i][2]];

                //enhance quantity if necessary
                if (quantityAndUnit.includes(".500"))
                    quantityAndUnit = quantityAndUnit.replace(".500", ".500");
                else if (quantityAndUnit.includes(".50"))
                    quantityAndUnit = quantityAndUnit.replace(".50", ".500");
                else if (quantityAndUnit.includes(".5"))
                    quantityAndUnit = quantityAndUnit.replace(".5", ".500");
                else if (quantityAndUnit.includes(".250"))
                    quantityAndUnit = quantityAndUnit.replace(".250", ".250");
                else if (quantityAndUnit.includes(".25"))
                    quantityAndUnit = quantityAndUnit.replace(".25", ".250");

                if (quantityAndUnit.slice(0, 4) == ".500")
                    quantityAndUnit = quantityAndUnit.replace(".500", "1/2");
                else if (quantityAndUnit.slice(0, 4) == ".250")
                    quantityAndUnit = quantityAndUnit.replace(".250", "1/4");

                if(quantityAndUnit.charAt(0) == '.') {
                    quantityAndUnit = "0" + quantityAndUnit;
                }

                doc.text(5.5 + xOffset, firstLineYPosition + (currentLine * lineHeight), quantityAndUnit, null, null, "left");
                doc.setFont("Gill Sans Std Condensed");

                //if product is being supplied then draw cirlce
                if (order[i][5] == "porPesarCamara" || order[i][5] == "yaPesadoCamara") {
                    drawAsterisk(doc, firstLineYPosition + (currentLine * lineHeight), "blue");
                    nproducts = nproducts + Math.ceil(parseFloat(order[i][1]));
                    ndiversity++;
                    onlyafuera = false;
                } else if (order[i][5] == "porPesarAfuera" || order[i][5] == "yaPesadoAfuera") {
                    drawCricle(doc, firstLineYPosition + (currentLine * lineHeight), "red");
                    nproducts = nproducts + Math.ceil(parseFloat(order[i][1]));
                    ndiversity++;
                }

                if(order[i][0] == "QU")
                    haspanela = true;

                if(order[i][0] == "ACL20")
                    hasBidon = true;

                if(order[i][0] == "CHN" || order[i][0] == "QUMI" || order[i][0] == "QUGI" || order[i][0] == "CHP")
                    hasChuletaN = true;

                //product price * quantity
                doc.setFont("Gill Sans MT Condensed Negrita");
                doc.setFontSize(12.5);
                product = JSON.search(defiantProducts, '//*[clave="' + order[i][0] + '"]');
                var totalProduct = roundDecimals(Math.round(order[i][4] * order[i][1] * 10) / 10);
                if (order[i][5] != "porPesarCamara" && order[i][5] != "porPesarAfuera") {
                    doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'), null, null, "left");
                } else {
                    doc.text(115 + xOffset, firstLineYPosition + (currentLine * lineHeight), totalProduct.toLocaleString('en-US'));
                    doc.setDrawColor(255, 0, 0);
                    doc.line(128 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 135  + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                    doc.setDrawColor(0, 0, 0);
                }
                
                //calculating current total
                var productTotal;
                if (order[i][1] < 0)
                    productTotal = order[i][4] * order[i][1] * (-1);
                else
                    productTotal = order[i][4] * order[i][1];
                
                total += productTotal;
                
                //notes and description
                doc.setFont("Gill Sans MT Condensed Negrita");

                if (order[i][5] != "") {
                    //notes and description
                    doc.setFontSize(10);
                    doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) + 1.5,replaceAEIOUN(order[i][5]));

                    doc.setFontSize(12.5);
                    doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight) - 1.5, replaceAEIOUN(order[i][3]));

                } else {
                    //just description
                    doc.setFontSize(12.5);
                    doc.text(22 + xOffset, firstLineYPosition + (currentLine * lineHeight), replaceAEIOUN(order[i][3]));
                }

                updateStock(order[i], orderMethod);

                //drawline if product needs to be weighted
                if (order[i][5] == "porPesarCamara" || order[i][5] == "porPesarAfuera") {
                    calculable = false;
                    doc.setLineWidth(0.35);
                    doc.setDrawColor(255, 0, 0);
                    doc.line(93 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8, 110 + xOffset, firstLineYPosition + (currentLine * lineHeight) + .8);
                    doc.setDrawColor(0, 0, 0);
                }

                currentLine++;
            }

            //if calculable then total
            doc.setFont("Gill Sans MT Condensed Negrita");
            doc.setFontSize(25);
            total = roundDecimals(Math.round(total * 10) / 10);
            if ((total / 1000) >= 1)
                total = total.toLocaleString('en-US')
            else
                total = total.toString();

            if (calculable) {
                doc.setPage(pagesQuantity * 2 - 1);
                doc.text(130.5 + xOffset, 209  + yOffset, "TOTAL  " + total.toLocaleString('en-US'), "right");

                //generates QR code with total embeded in
                for(var i = 1; i <= pagesQuantity; i++) {
                    doc.setPage(i);
                    productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                    //doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194  + yOffset, 15, 15);
                }
            } else {
                for(var i = 1; i <= pagesQuantity; i++) {
                    doc.setPage(i);
                    productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                    //doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194  + yOffset, 15, 15);
                }
                doc.setPage(pagesQuantity * 2 - 1);
                doc.text(130.5 + xOffset, 200  + yOffset, "APROX  " + total.toLocaleString('en-US'), "right");

                //generates QR code with total embeded in
                for(var i = 1; i <= pagesQuantity; i++) {
                    doc.setPage(i);
                    productsRefID = randomLetter1 + $("#inputName").val().trim() + " " + total.replace(/,/g, '') + randomLetter2;
                    //doc.addImage(generateQR(productsRefID), 'JPEG', 6 + xOffset, 194  + yOffset, 15, 15);
                }
            }

            //uploads buying order
            uploadCompleteOrder(replaceAEIOUN($("#inputName").val().trim()), order, total, productsRefID,orderMethod);
            
            //autoprints PDF in a new tab
            doc.autoPrint();
                        
            if(window.open(doc.output('bloburl'), '_blank') != null) { 
                eraseOrder();
            }
        }

        function updateStock(product, orderMethod) {

            //update current products stock
            var jsonProduct = JSON.search(defiantProducts, '//*[clave="' + product[0] + '"]')[0];
            if(jsonProduct.pesoN != undefined && jsonProduct.pesoN != "")
                product[1] = product[1] * jsonProduct.pesoN;
            substractStock(product[0], product[1], orderMethod);

            firebase.database().ref("relations/" + product[0]).once('value', function(snapshot) {
                if(snapshot.val() != undefined) {
                    if(Object.keys(snapshot.val()).length == 1) {
                        
                        //update parent products stock
                        substractStock(Object.keys(snapshot.val())[0], snapshot.val()[Object.keys(snapshot.val())[0]] * product[1], orderMethod);
                        
                        firebase.database().ref("relations/" + Object.keys(snapshot.val())[0]).once('value', function(childSnapshot) {
                            if(childSnapshot.val() != undefined) {
                                for (let id in childSnapshot.val()) {
                                    if(id != product[0]) {
                                        //update siblings products stock
                                        substractStock(id, childSnapshot.val()[id] * snapshot.val()[Object.keys(snapshot.val())[0]] * product[1], orderMethod);
                                    }
                                }
                            }
                        });
                    } else {
                        //means it's a parent product
                        for (let id in snapshot.val()) {
                            //update children products stock
                            substractStock(id, snapshot.val()[id] * product[1], orderMethod);
                        }
                    }
                }
            });
        }

        function substractStock(id, quantity, orderMethod) {
            var currentRelationStock = -1000000;
            firebase.database().ref("inventory/" + id + "/stock").once('value', function(snapshot) {
                if(snapshot.val() != undefined) {
                    currentRelationStock = parseInt(snapshot.val());
                    console.log("currentRelationStock");
                    console.log(currentRelationStock);
                }  
            }).then(function(){
                if(currentRelationStock != -1000000) {
                    console.log(orderMethod);
                    if(orderMethod == "MOSTRADOR" || orderMethod == "TELEFONO")
                        firebase.database().ref("inventory/" +  id + "/stock").set(currentRelationStock + parseInt(quantity));
                    else if(orderMethod == "WHATSAPP")
                        firebase.database().ref("inventory/" +  id + "/stock").set(currentRelationStock - parseInt(quantity));
                }
            });
        }

        //uploads order when invoice is needed
        function uploadCompleteOrder(name, products, total, id, orderMethod) {
            id = id.replace(".", "").replace(" ", "");
            total = total.replace(/\,/g,'');

            var destination = "";
            if(orderMethod == "MOSTRADOR")
                destination = "outsideToO";
            else if(orderMethod == "TELEFONO")
                destination = "imperialToO";
            else if(orderMethod == "WHATSAPP")
                destination = "ordenaToI";

            firebase.database().ref("purchases/" + destination + "/" + id).set({
                nombre: name,
                productos: products,
                subtotal: total,
                hour: Date.now()
            });
        }

        //uploads order when invoice is needed
        function uploadCompleteOrderWithCode(name, products, total, id, globalCodeType, code) {
            id = id.replaceAll(".", "").replaceAll(" ", "");
            total = total.replace(/\,/g,'');

            for(var i = 0; i < products.length; i++)
                products[i] = products[i].map(v => v === undefined ? '1' : v);
            
            firebase.database().ref("orders/" + globalCodeType + "/" + id).set({
                name: name,
                code: code,
                products: products,
                subtotal: total,
                hour: Date.now()
            });
        }

        function roundDecimals(number) {
            return Math.round(number * 2) / 2;
        }

        function round(number) {
            return Math.round((number * 1 + Number.EPSILON) * 100) / 100;
        }

        //adds a new page with all the values
        function addPagePDF(doc, orderMethod, length) {
            doc.addPage();
            addTimePDF(doc);
            addNamePDF(doc, length);
            addMethodPDF(doc, orderMethod);
        }

        //adds date and time to the top right corner
        function addTimePDF(doc) {
            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");

            var date = new Date();
            var months = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            var fullDate = date.getDate().toString() + " / " + months[date.getMonth()] + " / " + date.getFullYear().toString();
            doc.text(19.9 + xOffset, 30 + yOffset, fullDate, 'center');

            var hourWithMinutes = new Date().toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            doc.text(53.5  + xOffset, 30  + yOffset, hourWithMinutes, 'center');
        }

        function addMethodPDF(doc, orderMethod) {
            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");

            if(orderMethod == "MOSTRADOR")
                doc.text(111 + xOffset, 30  + yOffset, getCodeFormat(globalCode1), 'center');
            else if(orderMethod == "TELEFONO")
                doc.text(111 + xOffset, 30  + yOffset, getCodeFormat(globalCode2), 'center');
            else if(orderMethod == "WHATSAPP")
                doc.text(111 + xOffset, 30  + yOffset, getCodeFormat(globalCode2), 'center');


            if(orderMethod == "MOSTRADOR") {
                doc.text(84 + xOffset, 30  + yOffset, "COMPRA", 'center');
            } else if(orderMethod == "TELEFONO") {
                doc.text(84 + xOffset, 30  + yOffset, "DE IMPERIAL", 'center');
            } else if(orderMethod == "WHATSAPP") {
                doc.text(84 + xOffset, 30  + yOffset, "A IMPERIAL", 'center');
            }

            doc.setFontSize(70);
            doc.setTextColor(240, 240, 240);
            if(orderMethod == "MOSTRADOR") {
                if(globalID == "") doc.text(105, 120, "SIN REVISAR", "center");
                else doc.text(105, 120, "REVISADO", "center");
            } else if(orderMethod == "TELEFONO") {
                doc.text(105, 120, "SIN REVISAR", "center");
            } else if(orderMethod == "WHATSAPP") {
                doc.text(105, 120, "SIN REVISAR", "center");
            }
            doc.setFontSize(12.5);
            doc.setTextColor(0, 0, 0);
        }

        function getCodeFormat(code) {
            var codeToString = code.toString();
            while (codeToString.length < 5) codeToString = "0" + codeToString;
            return codeToString;
        }

        function addNamePDF(doc, length) {
            var name = $("#inputName").val().trim();

            doc.setFontSize(29);
            doc.setFont("Gill Sans MT Condensed Negrita");
            var cleanName = replaceAEIOUN(name);
            doc.text(68.5 + xOffset, 41.5  + yOffset, cleanName, "center");

            doc.setFontSize(12.5);
            doc.setFont("Gill Sans MT Condensed Negrita");
            
            return cleanName;
        }

        //draws circle besides the description        
        function drawCricle(doc, YCoordinate, validColor) {
            if (validColor == "blue")
                doc.text(4.5 + xOffset, YCoordinate - 1.5, "+", "center");
            else if (validColor == "red")
                doc.text(4.5 + xOffset, YCoordinate - .7, "-", "center");
        }

        function drawAsterisk(doc, YCoordinate, validColor) {
            if (validColor == "blue")
                doc.setFillColor(0, 0, 255);
            else if (validColor == "red")
                doc.setFillColor(255, 0, 0);

            doc.text(4.5  + xOffset, YCoordinate + 1, "*", null, null, "center");
        }

        //replaces special characters (current jspdf doesn´t support them)
        function replaceAEIOUN(string) {
            string = string.replace(/á/gi, "A");
            string = string.replace(/é/gi, "E");
            string = string.replace(/í/gi, "I");
            string = string.replace(/ó/gi, "O");
            string = string.replace(/ú/gi, "U");
            string = string.replace(/ñ/gi, "N");
            return string;
        }

        //generates a new QR code at the bottom left of the PDF, return a dataURL
        function generateQR(name) {
            name = name.replace("Ñ", "NN");
            document.getElementById('qrcode').innerHTML = "";
            var qrcode = new QRCode("qrcode", {
                text: name,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });
            console.log(name);
            qrid = name;
            var canvas = document.getElementById('qrcode').querySelector('canvas');
            return canvas.toDataURL();
        }

        function toAES(string) {
            return aesjs.utils.hex.fromBytes(aesEcb.encrypt(aesjs.utils.utf8.toBytes(to16Bytes(string))));
        }

        function to16Bytes(string) {
            return string + " ".repeat(16 - string.length);
        }

        //leaves the page ready for a new order
        function eraseOrder() {
            $("#inputName").val("");
            $("#inputNameWhatsapp").val("");
            $("#dynamic-list").html("");
            $("#dynamic-list-2").html("");

            $("#totalTextField").text("$0");
            $("#greenCheck").css("visibility", "hidden");
            $("#greenCheckW").css("visibility", "hidden");
            $("#greenCheckWN").css("visibility", "hidden");
            $("#greenCheckClient").css("visibility", "hidden");

            firebase.database().ref("liveviews/" + globalComputer + '/sorder').remove();
            clientName = "";
            clientWhatsapp = "";
            globalID = "";

            productCounter = 0;
            updateNP(productCounter);
        }

        //checks current connection status
        function checkConnection() {
            var printButton = document.getElementById("printButton");
            var connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function (snap) {
                if (snap.val() === true)
                    document.getElementById("noConnectionAlert").style.display = "none";
                else
                    document.getElementById("noConnectionAlert").style.display = "block";
            });
        }

        //listens to connection's stauts
        checkConnection();

    </script>

</body>